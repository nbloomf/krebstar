<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Buffers</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
<body>
<article>
<header>
<h1 class="title">Buffers</h1>
</header>
<div class="contents">
<ul>
<li><a href="#introduction">Introduction</a>: The problem we’re solving</li>
<li><a href="#point-manipulation">Point Manipulation</a>: Moving the read heads around</li>
<li><a href="#basic-mutation">Basic Mutation</a>: Cut, copy, alter, insert</li>
<li><a href="#queries">Queries</a>: Learning things about buffers</li>
<li><a href="#splitting">Splitting</a>: Moving the read heads around (again)</li>
<li><a href="#rendering">Rendering</a>: Displaying buffers to a virtual screen</li>
<li><a href="#testing-and-debugging">Testing and Debugging</a>: For when things go wrong</li>
</ul>
</div>
<div class="frontmatter">
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="ot">{-# LANGUAGE UndecidableInstances #-}</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="ot">{-# LANGUAGE InstanceSigs #-}</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">module</span> <span class="dt">Kreb.Text.Buffer</span> (</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="dt">Buffer</span>(<span class="fu">..</span>)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  , <span class="dt">BufferOp</span>(<span class="fu">..</span>)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  , empty</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  , singleton</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">  , fromList</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">  , fromFingerTree</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">  , toList</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">  , isEmpty</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">  , isSingleton</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">  , resizeBuffer</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">  , adjustBuffer</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">  , makeVacantBuffer</a>
<a class="sourceLine" id="cb1-21" data-line-number="21">  , makePointOnlyBuffer</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">  , makeCoincideBuffer</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">  , makePointMarkBuffer</a>
<a class="sourceLine" id="cb1-24" data-line-number="24">  , makeMarkPointBuffer</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">  , prepend</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">  , append</a>
<a class="sourceLine" id="cb1-27" data-line-number="27"></a>
<a class="sourceLine" id="cb1-28" data-line-number="28">  , isPointAtStart</a>
<a class="sourceLine" id="cb1-29" data-line-number="29">  , isPointAtEnd</a>
<a class="sourceLine" id="cb1-30" data-line-number="30">  , hasMark</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">  , isMarkAtStart</a>
<a class="sourceLine" id="cb1-32" data-line-number="32">  , isMarkAtEnd</a>
<a class="sourceLine" id="cb1-33" data-line-number="33">  , movePointToStart</a>
<a class="sourceLine" id="cb1-34" data-line-number="34">  , movePointToEnd</a>
<a class="sourceLine" id="cb1-35" data-line-number="35">  , moveMarkToStart</a>
<a class="sourceLine" id="cb1-36" data-line-number="36">  , moveMarkToEnd</a>
<a class="sourceLine" id="cb1-37" data-line-number="37">  , movePointLeft</a>
<a class="sourceLine" id="cb1-38" data-line-number="38">  , movePointRight</a>
<a class="sourceLine" id="cb1-39" data-line-number="39">  , moveMarkLeft</a>
<a class="sourceLine" id="cb1-40" data-line-number="40">  , moveMarkRight</a>
<a class="sourceLine" id="cb1-41" data-line-number="41">  , clearMark</a>
<a class="sourceLine" id="cb1-42" data-line-number="42">  , leaveMark</a>
<a class="sourceLine" id="cb1-43" data-line-number="43"></a>
<a class="sourceLine" id="cb1-44" data-line-number="44">  , readPoint</a>
<a class="sourceLine" id="cb1-45" data-line-number="45">  , insertPointLeft</a>
<a class="sourceLine" id="cb1-46" data-line-number="46">  , deletePointLeft</a>
<a class="sourceLine" id="cb1-47" data-line-number="47">  , insertAtStart</a>
<a class="sourceLine" id="cb1-48" data-line-number="48">  , deleteAtStart</a>
<a class="sourceLine" id="cb1-49" data-line-number="49">  , insertAtEnd</a>
<a class="sourceLine" id="cb1-50" data-line-number="50">  , deleteAtEnd</a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">{-</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">  , copyRegion</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">  , cutRegion</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">  , insertRegion</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">  , alterRegion</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">  , mapBuffer</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">  , mapRegion</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">-}</span></a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  , getBufferWidth</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  , getBufferTabStop</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  , getBufferCharCount</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  , getBufferByteCount</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">  , getBufferLineCol</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">  , getBufferScreenCoords</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">  , getBufferScreenOffset</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">  , getPointCharCount</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">  , getPointByteCount</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">  , getPointLineCol</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">  , getPointScreenCoords</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">  , getPointScreenOffset</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">  , getPointRuneId</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">  , getMarkCharCount</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  , getMarkByteCount</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  , getMarkLineCol</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  , getMarkScreenCoords</a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">  , movePoint</a>
<a class="sourceLine" id="cb3-21" data-line-number="21">  , movePointToLineCol</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">  , movePointToScreenCoords</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">  , movePointToScreenLine</a>
<a class="sourceLine" id="cb3-24" data-line-number="24">  , movePointToRuneId</a>
<a class="sourceLine" id="cb3-25" data-line-number="25">  , atOrAfterLineCol</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">  , atOrAfterScreenCoords</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">  , atOrAfterScreenLine</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">  , seekScreenCoords</a>
<a class="sourceLine" id="cb3-29" data-line-number="29">  , applyBufferOp</a>
<a class="sourceLine" id="cb3-30" data-line-number="30"></a>
<a class="sourceLine" id="cb3-31" data-line-number="31">  , hasFullScreenLine</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">  , takeFirstScreenLine</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">  , takeScreenLines</a>
<a class="sourceLine" id="cb3-34" data-line-number="34">  , getScreenLines</a>
<a class="sourceLine" id="cb3-35" data-line-number="35">  , attachLineNumbers</a>
<a class="sourceLine" id="cb3-36" data-line-number="36">  , attachColumnIndices</a>
<a class="sourceLine" id="cb3-37" data-line-number="37">  , renderScreenLinesWithRegion</a>
<a class="sourceLine" id="cb3-38" data-line-number="38"></a>
<a class="sourceLine" id="cb3-39" data-line-number="39">  , validate</a>
<a class="sourceLine" id="cb3-40" data-line-number="40">  , toAnnotatedList</a>
<a class="sourceLine" id="cb3-41" data-line-number="41">) <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-42" data-line-number="42"></a>
<a class="sourceLine" id="cb3-43" data-line-number="43"><span class="kw">import</span> <span class="dt">Data.Proxy</span></a>
<a class="sourceLine" id="cb3-44" data-line-number="44"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Foldable</span> <span class="kw">as</span> <span class="dt">Fold</span></a>
<a class="sourceLine" id="cb3-45" data-line-number="45"><span class="kw">import</span> <span class="dt">Data.List</span> (groupBy, sortOn)</a>
<a class="sourceLine" id="cb3-46" data-line-number="46"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Strict</span> <span class="kw">as</span> <span class="dt">M</span></a>
<a class="sourceLine" id="cb3-47" data-line-number="47"><span class="kw">import</span> <span class="dt">Control.Monad</span> (join)</a>
<a class="sourceLine" id="cb3-48" data-line-number="48"><span class="kw">import</span> <span class="dt">Debug.Trace</span></a>
<a class="sourceLine" id="cb3-49" data-line-number="49"></a>
<a class="sourceLine" id="cb3-50" data-line-number="50"><span class="kw">import</span>           <span class="dt">Kreb.Check</span></a>
<a class="sourceLine" id="cb3-51" data-line-number="51"><span class="kw">import</span>           <span class="dt">Kreb.Control</span></a>
<a class="sourceLine" id="cb3-52" data-line-number="52"><span class="kw">import</span>           <span class="dt">Kreb.Reflect</span></a>
<a class="sourceLine" id="cb3-53" data-line-number="53"><span class="kw">import</span>           <span class="dt">Kreb.Struct.Valued</span></a>
<a class="sourceLine" id="cb3-54" data-line-number="54"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Kreb.Struct.FingerTree</span> <span class="kw">as</span> <span class="dt">FT</span></a>
<a class="sourceLine" id="cb3-55" data-line-number="55"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Kreb.Struct.TwoPointedList</span> <span class="kw">as</span> <span class="dt">TPL</span></a>
<a class="sourceLine" id="cb3-56" data-line-number="56"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Kreb.Struct.RedBlackTree</span> <span class="kw">as</span> <span class="dt">RBT</span></a>
<a class="sourceLine" id="cb3-57" data-line-number="57"></a>
<a class="sourceLine" id="cb3-58" data-line-number="58"><span class="kw">import</span> <span class="dt">Kreb.Text.ScreenOffset</span></a>
<a class="sourceLine" id="cb3-59" data-line-number="59"><span class="kw">import</span> <span class="dt">Kreb.Text.Rune</span></a>
<a class="sourceLine" id="cb3-60" data-line-number="60"><span class="kw">import</span> <span class="dt">Kreb.Text.Pigment</span></a>
<a class="sourceLine" id="cb3-61" data-line-number="61"><span class="kw">import</span> <span class="dt">Kreb.Text.MeasureText</span></a>
<a class="sourceLine" id="cb3-62" data-line-number="62"><span class="kw">import</span> <span class="dt">Kreb.Text.Glyph</span></a>
<a class="sourceLine" id="cb3-63" data-line-number="63"><span class="kw">import</span> <span class="dt">Kreb.Text.Cell</span></a></code></pre></div>
</div>
<section id="introduction" class="level2">
<h2>Introduction</h2>
<p>Our primary data structure for representing and manipulating text is the <em>buffer</em>. At the semantic level we can treat buffers like lists of characters, although under the hood they use a more complex representation to make some important operations more efficient. The buffer also has one and possibly two distinguished positions, called the <em>point</em> and the <em>mark</em>, which are used to specify where edits take effect.</p>
<p>The actual definition of buffers builds on two other abstractions: two-pointed lists and our text measurement type. However these details aren’t exposed to client code.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Buffer</span> w t d a <span class="fu">=</span> <span class="dt">Buffer</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  { bufContents</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="ot">      ::</span> <span class="dt">TPL.TwoPointedList</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> (<span class="dt">Rune</span> d a))</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  , bufRemnants</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="ot">      ::</span> <span class="dt">RBT.RedBlackTree</span> (<span class="dt">Rune</span> d a)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  }</a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">IsChar</span> a</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  ) <span class="ot">=&gt;</span> <span class="dt">Eq</span> (<span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    (<span class="dt">Buffer</span> w1 _) <span class="fu">==</span> (<span class="dt">Buffer</span> w2 _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">      (map (toChar <span class="fu">.</span> fmap getRuneValue) <span class="fu">$</span> Fold.toList w1)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">       <span class="fu">==</span> (map (toChar <span class="fu">.</span> fmap getRuneValue) <span class="fu">$</span> Fold.toList w2)</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">data</span> <span class="dt">BufferOp</span> d a</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="fu">=</span> <span class="dt">BufferOpIns</span> (<span class="dt">Rune</span> d a)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="fu">|</span> <span class="dt">BufferOpDel</span> (<span class="dt">Rune</span> d a)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="fu">|</span> <span class="dt">BufferNoOp</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</a></code></pre></div>
<p>Note that <code>MeasureText</code> takes two type parameters, <code>w</code> and <code>t</code>. These are type level representations of the width of the screen in cells and the tab stop width, respectively. Our underlying finger tree implementation makes it necessary that these be type parameters; essentially they are required by the monoid instance on text measurements. Later on we’ll wrap buffers inside an existential type to partially hide this detail while maintaining type safety.</p>
<p>We also impose one invariant on buffers that can’t be represented in the type: the final item in the list of characters must be a special end-of-file sigil. This simplifies the usual insert and delete operations on text by making it possible to assert that the “cursor” is at the left edge of a cell. We will have to be careful that our operations on buffers maintain this invariant (only in this module; client code shouldn’t need to worry about that).</p>
<p>Because buffers are “just” two pointed lists, they inherit the API of two pointed lists, giving us a decent amount of code nearly for free (modulo maintaining the eof invariant). We can measure the entire buffer:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  ) <span class="ot">=&gt;</span> <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    value <span class="fu">=</span> value <span class="fu">.</span> TPL.integrate <span class="fu">.</span> bufContents</a></code></pre></div>
<p>We also get the usual <code>empty</code> and <code>singleton</code> constructors.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1">empty</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">empty <span class="fu">=</span> <span class="dt">Buffer</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  (TPL.singleton (<span class="ot">eof ::</span> <span class="dt">Cell</span> (<span class="dt">Rune</span> d a))) RBT.empty</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">singleton</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">singleton eId a <span class="fu">=</span> <span class="dt">Buffer</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  (TPL.fromList (map <span class="dt">Cell</span> (makeRunes eId [a]) <span class="fu">++</span> [ eof ])) RBT.empty</a></code></pre></div>
<p>More generally, we can convert lists to buffers (and back again).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1">fromList</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">fromList eId xs <span class="fu">=</span> <span class="dt">Buffer</span> (TPL.fromList <span class="fu">$</span> concat</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  [ map <span class="dt">Cell</span> <span class="fu">$</span> makeRunes eId xs, [<span class="ot"> eof ::</span> <span class="dt">Cell</span> (<span class="dt">Rune</span> d a) ] ]) RBT.empty</a>
<a class="sourceLine" id="cb9-7" data-line-number="7"></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">fromFingerTree</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">fromFingerTree eId <span class="fu">=</span> fromList eId <span class="fu">.</span> Fold.toList</a>
<a class="sourceLine" id="cb9-13" data-line-number="13"></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">toList</a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">toList (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">  map getRuneValue <span class="fu">$</span> unCells <span class="fu">$</span> Fold.toList w</a></code></pre></div>
<p>Due to the EOF sigil, detecting when a buffer is empty or a singleton is a little more involved.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1">isEmpty</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsChar</span> a, <span class="dt">Eq</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">isEmpty (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  <span class="kw">case</span> TPL.viewAtEnd w <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> error <span class="st">&quot;isEmpty: panic (expected eof)&quot;</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">    <span class="dt">Just</span> (a, as) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">      (a <span class="fu">==</span> (<span class="ot">eof ::</span> <span class="dt">Cell</span> (<span class="dt">Rune</span> d a))) <span class="fu">&amp;&amp;</span> (TPL.isEmpty as)</a>
<a class="sourceLine" id="cb10-11" data-line-number="11"></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">isSingleton</a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">   <span class="fu">.</span> ( <span class="dt">IsChar</span> a, <span class="dt">Eq</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">isSingleton (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">  <span class="kw">case</span> TPL.viewAtEnd w <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> error <span class="st">&quot;isSingleton: panic (expected eof)&quot;</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">    <span class="dt">Just</span> (a, as) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">      (a <span class="fu">==</span> (<span class="ot">eof ::</span> <span class="dt">Cell</span> (<span class="dt">Rune</span> d a))) <span class="fu">&amp;&amp;</span> (TPL.isSingleton as)</a></code></pre></div>
<p>It will also be handy to be able to resize the buffer in two different ways, depending on whether we want to specify the new parameters ‘statically’ or ‘dynamically’.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1">resizeBuffer</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="ot">  ::</span> forall w1 t1 w2 t2 d a</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">     , <span class="dt">IsWidth</span> w1, <span class="dt">IsTab</span> t1, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w1 t1 d) a</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">     , <span class="dt">IsWidth</span> w2, <span class="dt">IsTab</span> t2, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w2 t2 d) a )</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w1 t1 d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w2 t2 d a</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">resizeBuffer (<span class="dt">Buffer</span> c r) <span class="fu">=</span> <span class="dt">Buffer</span> (TPL.remeasure c) r</a>
<a class="sourceLine" id="cb11-8" data-line-number="8"></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">adjustBuffer</a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="ot">  ::</span> ( <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">     , <span class="dt">IsWidth</span> w1, <span class="dt">IsTab</span> t1, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w1 t1 d) a</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">     , <span class="dt">IsWidth</span> w2, <span class="dt">IsTab</span> t2, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w2 t2 d) a )</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">  <span class="ot">=&gt;</span> <span class="dt">Proxy</span> w2 <span class="ot">-&gt;</span> <span class="dt">Proxy</span> t2 <span class="ot">-&gt;</span> <span class="dt">Proxy</span> d</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">  <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w1 t1 d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w2 t2 d a</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">adjustBuffer _ _ _ <span class="fu">=</span> resizeBuffer</a></code></pre></div>
<p>We’ll also go ahead and define some special constructors for building buffers of a very specific structure. These should only be used for testing and debugging, but we need to define them early in the module so we can use them in examples as we go. These correspond to the nontrivial constructors of two-pointed lists.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1">makeVacantBuffer</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Proxy</span> w <span class="ot">-&gt;</span> <span class="dt">Proxy</span> t <span class="ot">-&gt;</span> <span class="dt">Proxy</span> d <span class="ot">-&gt;</span> <span class="dt">Proxy</span> a</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">  <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">makeVacantBuffer _ _ _ _ <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">  <span class="dt">Buffer</span> (TPL.singleton (<span class="ot">eof ::</span> <span class="dt">Cell</span> (<span class="dt">Rune</span> d a))) RBT.empty</a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">makePointOnlyBuffer</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">  <span class="ot">=&gt;</span> <span class="dt">Proxy</span> w <span class="ot">-&gt;</span> <span class="dt">Proxy</span> t <span class="ot">-&gt;</span> <span class="dt">Proxy</span> d</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">  <span class="ot">-&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">makePointOnlyBuffer _ _ _ eId as&#39; x&#39; bs&#39; <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15">  <span class="kw">let</span> (as, x, bs) <span class="fu">=</span> makeRunes2 eId as&#39; x&#39; bs&#39;</a>
<a class="sourceLine" id="cb12-16" data-line-number="16">  <span class="kw">in</span> <span class="dt">Buffer</span> (TPL.makePointOnly</a>
<a class="sourceLine" id="cb12-17" data-line-number="17">    (map <span class="dt">Cell</span> as) (<span class="dt">Cell</span> x) (map <span class="dt">Cell</span> bs <span class="fu">++</span> [eof])) RBT.empty</a>
<a class="sourceLine" id="cb12-18" data-line-number="18"></a>
<a class="sourceLine" id="cb12-19" data-line-number="19">makeCoincideBuffer</a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb12-21" data-line-number="21">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">  <span class="ot">=&gt;</span> <span class="dt">Proxy</span> w <span class="ot">-&gt;</span> <span class="dt">Proxy</span> t <span class="ot">-&gt;</span> <span class="dt">Proxy</span> d</a>
<a class="sourceLine" id="cb12-23" data-line-number="23">  <span class="ot">-&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb12-24" data-line-number="24">makeCoincideBuffer _ _ _ eId as&#39; x&#39; bs&#39; <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25">  <span class="kw">let</span> (as, x, bs) <span class="fu">=</span> makeRunes2 eId as&#39; x&#39; bs&#39;</a>
<a class="sourceLine" id="cb12-26" data-line-number="26">  <span class="kw">in</span> <span class="dt">Buffer</span> (TPL.makeCoincide</a>
<a class="sourceLine" id="cb12-27" data-line-number="27">    (map <span class="dt">Cell</span> as) (<span class="dt">Cell</span> x) (map <span class="dt">Cell</span> bs <span class="fu">++</span> [eof])) RBT.empty</a>
<a class="sourceLine" id="cb12-28" data-line-number="28"></a>
<a class="sourceLine" id="cb12-29" data-line-number="29">makePointMarkBuffer</a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb12-31" data-line-number="31">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb12-32" data-line-number="32">  <span class="ot">=&gt;</span> <span class="dt">Proxy</span> w <span class="ot">-&gt;</span> <span class="dt">Proxy</span> t <span class="ot">-&gt;</span> <span class="dt">Proxy</span> d</a>
<a class="sourceLine" id="cb12-33" data-line-number="33">  <span class="ot">-&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb12-34" data-line-number="34">makePointMarkBuffer _ _ _ eId as&#39; x&#39; bs&#39; y&#39; cs&#39; <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35">  <span class="kw">let</span> (as, x, bs, y, cs) <span class="fu">=</span> makeRunes3 eId as&#39; x&#39; bs&#39; y&#39; cs&#39;</a>
<a class="sourceLine" id="cb12-36" data-line-number="36">  <span class="kw">in</span> <span class="dt">Buffer</span> (TPL.makePointMark</a>
<a class="sourceLine" id="cb12-37" data-line-number="37">    (map <span class="dt">Cell</span> as) (<span class="dt">Cell</span> x) (map <span class="dt">Cell</span> bs)</a>
<a class="sourceLine" id="cb12-38" data-line-number="38">    (<span class="dt">Cell</span> y) (map <span class="dt">Cell</span> cs <span class="fu">++</span> [eof])) RBT.empty</a>
<a class="sourceLine" id="cb12-39" data-line-number="39"></a>
<a class="sourceLine" id="cb12-40" data-line-number="40">makeMarkPointBuffer</a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb12-42" data-line-number="42">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb12-43" data-line-number="43">  <span class="ot">=&gt;</span> <span class="dt">Proxy</span> w <span class="ot">-&gt;</span> <span class="dt">Proxy</span> t <span class="ot">-&gt;</span> <span class="dt">Proxy</span> d</a>
<a class="sourceLine" id="cb12-44" data-line-number="44">  <span class="ot">-&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb12-45" data-line-number="45">makeMarkPointBuffer _ _ _ eId as&#39; x&#39; bs&#39; y&#39; cs&#39; <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-46" data-line-number="46">  <span class="kw">let</span> (as, x, bs, y, cs) <span class="fu">=</span> makeRunes3 eId as&#39; x&#39; bs&#39; y&#39; cs&#39;</a>
<a class="sourceLine" id="cb12-47" data-line-number="47">  <span class="kw">in</span> <span class="dt">Buffer</span> (TPL.makeMarkPoint</a>
<a class="sourceLine" id="cb12-48" data-line-number="48">    (map <span class="dt">Cell</span> as) (<span class="dt">Cell</span> x) (map <span class="dt">Cell</span> bs)</a>
<a class="sourceLine" id="cb12-49" data-line-number="49">    (<span class="dt">Cell</span> y) (map <span class="dt">Cell</span> cs <span class="fu">++</span> [eof])) RBT.empty</a></code></pre></div>
</section>
<section id="point-manipulation" class="level2">
<h2>Point Manipulation</h2>
<p>The point and mark of a buffer represent the read head, and moving them around is one of the most important and common tasks our code needs to handle. We inherit a decent API for this from two-pointed lists which we can basically re-expose. First some queries on the point and mark:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1">isPointAtStart</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">isPointAtStart <span class="fu">=</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">  TPL.isPointAtStart <span class="fu">.</span> bufContents</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">isPointAtEnd</a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">isPointAtEnd <span class="fu">=</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11">  TPL.isPointAtEnd <span class="fu">.</span> bufContents</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">hasMark</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">hasMark <span class="fu">=</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17">  TPL.hasMark <span class="fu">.</span> bufContents</a>
<a class="sourceLine" id="cb13-18" data-line-number="18"></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">isMarkAtStart</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb13-21" data-line-number="21">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22">isMarkAtStart <span class="fu">=</span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23">  TPL.isMarkAtStart <span class="fu">.</span> bufContents</a>
<a class="sourceLine" id="cb13-24" data-line-number="24"></a>
<a class="sourceLine" id="cb13-25" data-line-number="25">isMarkAtEnd</a>
<a class="sourceLine" id="cb13-26" data-line-number="26"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb13-28" data-line-number="28">isMarkAtEnd <span class="fu">=</span></a>
<a class="sourceLine" id="cb13-29" data-line-number="29">  TPL.isMarkAtEnd <span class="fu">.</span> bufContents</a></code></pre></div>
<p>Next some basic operators for moving either the point or the mark to one of the ends of the buffer.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1">movePointToStart</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">movePointToStart (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">  <span class="dt">Buffer</span> (TPL.movePointToStart w) del</a>
<a class="sourceLine" id="cb14-6" data-line-number="6"></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">movePointToEnd</a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">movePointToEnd (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  <span class="dt">Buffer</span> (TPL.movePointToEnd w) del</a>
<a class="sourceLine" id="cb14-12" data-line-number="12"></a>
<a class="sourceLine" id="cb14-13" data-line-number="13">moveMarkToStart</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">moveMarkToStart (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17">  <span class="dt">Buffer</span> (TPL.moveMarkToStart w) del</a>
<a class="sourceLine" id="cb14-18" data-line-number="18"></a>
<a class="sourceLine" id="cb14-19" data-line-number="19">moveMarkToEnd</a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb14-21" data-line-number="21">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb14-22" data-line-number="22">moveMarkToEnd (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb14-23" data-line-number="23">  <span class="dt">Buffer</span> (TPL.moveMarkToEnd w) del</a></code></pre></div>
<p>We also have operators for moving the point and mark one cell to the left or right.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1">movePointLeft</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">movePointLeft (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">  <span class="dt">Buffer</span> (TPL.movePointLeft w) del</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"></a>
<a class="sourceLine" id="cb15-7" data-line-number="7">movePointRight</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">movePointRight (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11">  <span class="dt">Buffer</span> (TPL.movePointRight w) del</a>
<a class="sourceLine" id="cb15-12" data-line-number="12"></a>
<a class="sourceLine" id="cb15-13" data-line-number="13">moveMarkLeft</a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">moveMarkLeft (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb15-17" data-line-number="17">  <span class="dt">Buffer</span> (TPL.moveMarkLeft w) del</a>
<a class="sourceLine" id="cb15-18" data-line-number="18"></a>
<a class="sourceLine" id="cb15-19" data-line-number="19">moveMarkRight</a>
<a class="sourceLine" id="cb15-20" data-line-number="20"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb15-22" data-line-number="22">moveMarkRight (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb15-23" data-line-number="23">  <span class="dt">Buffer</span> (TPL.moveMarkRight w) del</a></code></pre></div>
<p>We also have utilities for setting and clearing the mark. Recall that both <code>clearMark</code> and <code>leaveMark</code> leave the point unchanged; <code>clearMark</code> removes the mark, and <code>leaveMark</code> sets or resets it to coincide with the point.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" data-line-number="1">clearMark</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">clearMark (<span class="dt">Buffer</span> c r) <span class="fu">=</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">  <span class="dt">Buffer</span> (TPL.clearMark c) r</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7">leaveMark</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">leaveMark (<span class="dt">Buffer</span> c r) <span class="fu">=</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">  <span class="dt">Buffer</span> (TPL.leaveMark c) r</a></code></pre></div>
</section>
<section id="basic-mutation" class="level2">
<h2>Basic Mutation</h2>
<p>Next we need buffer versions of the region operators. We can read the character at the point:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" data-line-number="1">readPoint</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="ot">  ::</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Cell</span> a)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">readPoint (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">  fmap (fmap getRuneValue) <span class="fu">$</span> TPL.readPoint w</a></code></pre></div>
<p>And we need left-biased insert and delete at the point.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" data-line-number="1">insertPointLeft</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w t d a, <span class="dt">BufferOp</span> d a)</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">insertPointLeft eId a (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6">    u <span class="fu">=</span> <span class="kw">case</span> TPL.valuesAroundPoint w <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">      <span class="dt">Nothing</span>    <span class="ot">-&gt;</span> (<span class="dt">Infimum</span>, <span class="dt">Supremum</span>)</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">      <span class="dt">Just</span> (x,y) <span class="ot">-&gt;</span> (runeId x, runeId y)</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">    v <span class="fu">=</span> newRuneId eId u a</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">  <span class="kw">in</span> (<span class="dt">Buffer</span> (TPL.insertPointLeft (<span class="dt">Cell</span> v) w) del, <span class="dt">BufferOpIns</span> v)</a>
<a class="sourceLine" id="cb18-11" data-line-number="11"></a>
<a class="sourceLine" id="cb18-12" data-line-number="12">deletePointLeft</a>
<a class="sourceLine" id="cb18-13" data-line-number="13"><span class="ot">  ::</span> ( <span class="dt">IsChar</span> a, <span class="dt">Ord</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w t d a, <span class="dt">BufferOp</span> d a)</a>
<a class="sourceLine" id="cb18-16" data-line-number="16">deletePointLeft eId (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17">  <span class="kw">case</span> TPL.deletePointLeft&#39; w <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-18" data-line-number="18">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w del, <span class="dt">BufferNoOp</span>)</a>
<a class="sourceLine" id="cb18-19" data-line-number="19">    <span class="dt">Just</span> (w&#39;, a) <span class="ot">-&gt;</span> <span class="kw">case</span> a <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-20" data-line-number="20">      <span class="dt">Cell</span> c <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w&#39; (RBT.insert c del), <span class="dt">BufferOpDel</span> (setEventId eId c))</a>
<a class="sourceLine" id="cb18-21" data-line-number="21">      <span class="dt">EOF</span> <span class="ot">-&gt;</span> error <span class="st">&quot;deletePointLeft: panic&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co">{-</span></a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" data-line-number="1">copyRegion</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">copyRegion (<span class="dt">Buffer</span> w) <span class="fu">=</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5">  fmap (fromFingerTree <span class="fu">.</span> FT.inflateWith listCell)</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">    <span class="fu">$</span> TPL.copyRegionL w</a></code></pre></div>
<p>As well we have versions of <code>copy</code>, <code>cut</code>, and <code>insert</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" data-line-number="1"></a>
<a class="sourceLine" id="cb21-2" data-line-number="2">cutRegion</a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Buffer</span> w t d a, <span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">cutRegion (<span class="dt">Buffer</span> w) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6">  (region, rest) <span class="ot">&lt;-</span> TPL.cutRegionL w</a>
<a class="sourceLine" id="cb21-7" data-line-number="7">  return</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">    ( fromFingerTree <span class="fu">$</span> FT.inflateWith listCell region</a>
<a class="sourceLine" id="cb21-9" data-line-number="9">    , <span class="dt">Buffer</span> rest )</a>
<a class="sourceLine" id="cb21-10" data-line-number="10"></a>
<a class="sourceLine" id="cb21-11" data-line-number="11">insertRegion</a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb21-13" data-line-number="13">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb21-14" data-line-number="14">insertRegion (<span class="dt">Buffer</span> snippet) (<span class="dt">Buffer</span> w) <span class="fu">=</span></a>
<a class="sourceLine" id="cb21-15" data-line-number="15">  <span class="dt">Buffer</span> <span class="fu">$</span> TPL.insertRegionL (TPL.integrate snippet) w</a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="fu">-</span>}</a></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" data-line-number="1">alterRegion</a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">  <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">alterRegion f (<span class="dt">Buffer</span> c r) <span class="fu">=</span></a>
<a class="sourceLine" id="cb23-6" data-line-number="6">  <span class="dt">Buffer</span> (TPL.alterRegionL g c) r</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb23-8" data-line-number="8"><span class="ot">    g ::</span> <span class="dt">Cell</span> (<span class="dt">Rune</span> d a) <span class="ot">-&gt;</span> <span class="dt">Cell</span> (<span class="dt">Rune</span> d a)</a>
<a class="sourceLine" id="cb23-9" data-line-number="9">    g x <span class="fu">=</span> <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb23-10" data-line-number="10">      <span class="dt">Cell</span> a <span class="ot">-&gt;</span> <span class="dt">Cell</span> (fmap f a)</a>
<a class="sourceLine" id="cb23-11" data-line-number="11">      _ <span class="ot">-&gt;</span> x</a></code></pre></div>
<p>We can also efficiently manipulate the start and end of the buffer.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" data-line-number="1">insertAtStart</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w t d a, <span class="dt">BufferOp</span> d a)</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">insertAtStart eId a (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6">    u <span class="fu">=</span> <span class="kw">case</span> TPL.valuesAroundStart w <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-7" data-line-number="7">      <span class="dt">Nothing</span>    <span class="ot">-&gt;</span> (<span class="dt">Infimum</span>, <span class="dt">Supremum</span>)</a>
<a class="sourceLine" id="cb24-8" data-line-number="8">      <span class="dt">Just</span> (x,y) <span class="ot">-&gt;</span> (runeId x, runeId y)</a>
<a class="sourceLine" id="cb24-9" data-line-number="9">    v <span class="fu">=</span> newRuneId eId u a</a>
<a class="sourceLine" id="cb24-10" data-line-number="10">  <span class="kw">in</span> (<span class="dt">Buffer</span> (TPL.insertAtStart (<span class="dt">Cell</span> v) w) del, <span class="dt">BufferOpIns</span> v)</a>
<a class="sourceLine" id="cb24-11" data-line-number="11"></a>
<a class="sourceLine" id="cb24-12" data-line-number="12">prepend</a>
<a class="sourceLine" id="cb24-13" data-line-number="13"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb24-14" data-line-number="14">   <span class="fu">.</span> ( <span class="dt">Ord</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb24-15" data-line-number="15">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb24-16" data-line-number="16">  <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w t d a, [<span class="dt">BufferOp</span> d a])</a>
<a class="sourceLine" id="cb24-17" data-line-number="17">prepend eId cs b <span class="fu">=</span> prepend&#39; b (reverse cs) []</a>
<a class="sourceLine" id="cb24-18" data-line-number="18">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb24-19" data-line-number="19">    prepend&#39; x as ops <span class="fu">=</span> <span class="kw">case</span> as <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-20" data-line-number="20">      [] <span class="ot">-&gt;</span> (x, ops)</a>
<a class="sourceLine" id="cb24-21" data-line-number="21">      z<span class="fu">:</span>zs <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb24-22" data-line-number="22">        <span class="kw">let</span> (y, op) <span class="fu">=</span> insertAtStart eId z x</a>
<a class="sourceLine" id="cb24-23" data-line-number="23">        <span class="kw">in</span> prepend&#39; y zs (op<span class="fu">:</span>ops)</a>
<a class="sourceLine" id="cb24-24" data-line-number="24"></a>
<a class="sourceLine" id="cb24-25" data-line-number="25">deleteAtStart</a>
<a class="sourceLine" id="cb24-26" data-line-number="26"><span class="ot">  ::</span> ( <span class="dt">IsChar</span> a, <span class="dt">Ord</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb24-27" data-line-number="27">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb24-28" data-line-number="28">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w t d a, <span class="dt">BufferOp</span> d a)</a>
<a class="sourceLine" id="cb24-29" data-line-number="29">deleteAtStart eId (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb24-30" data-line-number="30">  <span class="kw">case</span> TPL.viewAtEnd w <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-31" data-line-number="31">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> error <span class="st">&quot;deleteAtStart: panic (empty buffer)&quot;</span></a>
<a class="sourceLine" id="cb24-32" data-line-number="32">    <span class="dt">Just</span> (u, us) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb24-33" data-line-number="33">      <span class="kw">case</span> TPL.deleteAtStart&#39; us <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-34" data-line-number="34">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w del, <span class="dt">BufferNoOp</span>)</a>
<a class="sourceLine" id="cb24-35" data-line-number="35">        <span class="dt">Just</span> (w&#39;, a) <span class="ot">-&gt;</span> <span class="kw">case</span> a <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-36" data-line-number="36">          <span class="dt">EOF</span> <span class="ot">-&gt;</span> error <span class="st">&quot;deletePointLeft: panic&quot;</span></a>
<a class="sourceLine" id="cb24-37" data-line-number="37">          <span class="dt">Cell</span> c <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb24-38" data-line-number="38">            ( <span class="dt">Buffer</span> (TPL.insertAtEnd u w&#39;) (RBT.insert c del)</a>
<a class="sourceLine" id="cb24-39" data-line-number="39">            , <span class="dt">BufferOpDel</span> (setEventId eId c)</a>
<a class="sourceLine" id="cb24-40" data-line-number="40">            )</a>
<a class="sourceLine" id="cb24-41" data-line-number="41"></a>
<a class="sourceLine" id="cb24-42" data-line-number="42">insertAtEnd</a>
<a class="sourceLine" id="cb24-43" data-line-number="43"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb24-44" data-line-number="44">   <span class="fu">.</span> ( <span class="dt">Ord</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb24-45" data-line-number="45">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w t d a, <span class="dt">BufferOp</span> d a)</a>
<a class="sourceLine" id="cb24-46" data-line-number="46">insertAtEnd eId a (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb24-47" data-line-number="47">  <span class="kw">case</span> TPL.viewAtEnd w <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-48" data-line-number="48">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> error <span class="st">&quot;insertAtEnd: panic (empty buffer)&quot;</span></a>
<a class="sourceLine" id="cb24-49" data-line-number="49">    <span class="dt">Just</span> (z, us) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb24-50" data-line-number="50">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb24-51" data-line-number="51">        u <span class="fu">=</span> <span class="kw">case</span> TPL.viewAtEnd us <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-52" data-line-number="52">          <span class="dt">Nothing</span>    <span class="ot">-&gt;</span> (<span class="dt">Infimum</span>, <span class="dt">Supremum</span>)</a>
<a class="sourceLine" id="cb24-53" data-line-number="53">          <span class="dt">Just</span> (x,y) <span class="ot">-&gt;</span> (runeId (value<span class="ot"> x ::</span> <span class="dt">MeasureText</span> w t d), <span class="dt">Supremum</span>)</a>
<a class="sourceLine" id="cb24-54" data-line-number="54">        v <span class="fu">=</span> newRuneId eId u a</a>
<a class="sourceLine" id="cb24-55" data-line-number="55">      <span class="kw">in</span></a>
<a class="sourceLine" id="cb24-56" data-line-number="56">        ( <span class="dt">Buffer</span> (TPL.insertAtEnd z <span class="fu">$</span> TPL.insertAtEnd (<span class="dt">Cell</span> v) us) del</a>
<a class="sourceLine" id="cb24-57" data-line-number="57">        , <span class="dt">BufferOpIns</span> v</a>
<a class="sourceLine" id="cb24-58" data-line-number="58">        )</a>
<a class="sourceLine" id="cb24-59" data-line-number="59"></a>
<a class="sourceLine" id="cb24-60" data-line-number="60">append</a>
<a class="sourceLine" id="cb24-61" data-line-number="61"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb24-62" data-line-number="62">   <span class="fu">.</span> ( <span class="dt">Ord</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb24-63" data-line-number="63">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb24-64" data-line-number="64">  <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w t d a, [<span class="dt">BufferOp</span> d a])</a>
<a class="sourceLine" id="cb24-65" data-line-number="65">append eId cs b <span class="fu">=</span> append&#39; b cs []</a>
<a class="sourceLine" id="cb24-66" data-line-number="66">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb24-67" data-line-number="67">    append&#39; x as ops <span class="fu">=</span> <span class="kw">case</span> as <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-68" data-line-number="68">      [] <span class="ot">-&gt;</span> (x, ops)</a>
<a class="sourceLine" id="cb24-69" data-line-number="69">      z<span class="fu">:</span>zs <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb24-70" data-line-number="70">        <span class="kw">let</span> (y, op) <span class="fu">=</span> insertAtEnd eId z x</a>
<a class="sourceLine" id="cb24-71" data-line-number="71">        <span class="kw">in</span> append&#39; y zs (op<span class="fu">:</span>ops)</a>
<a class="sourceLine" id="cb24-72" data-line-number="72"></a>
<a class="sourceLine" id="cb24-73" data-line-number="73">deleteAtEnd</a>
<a class="sourceLine" id="cb24-74" data-line-number="74"><span class="ot">  ::</span> ( <span class="dt">IsChar</span> a, <span class="dt">Ord</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb24-75" data-line-number="75">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb24-76" data-line-number="76">  <span class="ot">=&gt;</span> <span class="dt">EventId</span> <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w t d a, <span class="dt">BufferOp</span> d a)</a>
<a class="sourceLine" id="cb24-77" data-line-number="77">deleteAtEnd eId (<span class="dt">Buffer</span> w del) <span class="fu">=</span></a>
<a class="sourceLine" id="cb24-78" data-line-number="78">  <span class="kw">case</span> TPL.viewAtEnd w <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-79" data-line-number="79">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> error <span class="st">&quot;deleteAtEnd: panic (empty buffer)&quot;</span></a>
<a class="sourceLine" id="cb24-80" data-line-number="80">    <span class="dt">Just</span> (u, us) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb24-81" data-line-number="81">      <span class="kw">case</span> TPL.viewAtEnd us <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-82" data-line-number="82">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> (<span class="dt">Buffer</span> w del, <span class="dt">BufferNoOp</span>)</a>
<a class="sourceLine" id="cb24-83" data-line-number="83">        <span class="dt">Just</span> (a, w&#39;) <span class="ot">-&gt;</span> <span class="kw">case</span> a <span class="kw">of</span></a>
<a class="sourceLine" id="cb24-84" data-line-number="84">          <span class="dt">EOF</span> <span class="ot">-&gt;</span> error <span class="st">&quot;deletePointLeft: panic&quot;</span></a>
<a class="sourceLine" id="cb24-85" data-line-number="85">          <span class="dt">Cell</span> c <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb24-86" data-line-number="86">            ( <span class="dt">Buffer</span> (TPL.insertAtEnd u w&#39;) (RBT.insert c del)</a>
<a class="sourceLine" id="cb24-87" data-line-number="87">            , <span class="dt">BufferOpDel</span> (setEventId eId c)</a>
<a class="sourceLine" id="cb24-88" data-line-number="88">            )</a></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co">{-</span></a></code></pre></div>
<p>We can also map over the entries in a buffer.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" data-line-number="1">mapBuffer</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a1</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a2 )</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">  <span class="ot">=&gt;</span> (a1 <span class="ot">-&gt;</span> a2) <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a1 <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a2</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">mapBuffer f (<span class="dt">Buffer</span> c r) <span class="fu">=</span></a>
<a class="sourceLine" id="cb26-7" data-line-number="7">  <span class="dt">Buffer</span> (TPL.fmapTPL (fmap (fmap f)) c) r</a>
<a class="sourceLine" id="cb26-8" data-line-number="8"></a>
<a class="sourceLine" id="cb26-9" data-line-number="9">mapRegion</a>
<a class="sourceLine" id="cb26-10" data-line-number="10"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">  <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb26-12" data-line-number="12">mapRegion f <span class="fu">=</span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13">  <span class="dt">Buffer</span> <span class="fu">.</span> TPL.alterRegionL (fmap (fmap f)) <span class="fu">.</span> unBuffer</a></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="fu">-</span>}</a></code></pre></div>
</section>
<section id="queries" class="level2">
<h2>Queries</h2>
<p>More than any of the data structures we’ve seen so far, buffers have <em>properties</em>. We now define an interface through which other modules can query these properties; for consistency’s sake these all start with <code>get</code>. First some functions for reifying the type level parameters: width and tab stop.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" data-line-number="1">getBufferWidth</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb28-5" data-line-number="5">getBufferWidth _ <span class="fu">=</span> toWidth (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> w)</a>
<a class="sourceLine" id="cb28-6" data-line-number="6"></a>
<a class="sourceLine" id="cb28-7" data-line-number="7">getBufferTabStop</a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb28-9" data-line-number="9">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb28-10" data-line-number="10">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11">getBufferTabStop _ <span class="fu">=</span> toTab (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> t)</a></code></pre></div>
<p>Next we have queries on the measure of the entire buffer.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb29-1" data-line-number="1">getBufferCharCount</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb29-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5">getBufferCharCount (<span class="dt">Buffer</span> buf _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb29-6" data-line-number="6">  <span class="kw">let</span> m <span class="fu">=</span> value<span class="ot"> buf ::</span> <span class="dt">MeasureText</span> w t d <span class="kw">in</span></a>
<a class="sourceLine" id="cb29-7" data-line-number="7">  charCount m</a>
<a class="sourceLine" id="cb29-8" data-line-number="8"></a>
<a class="sourceLine" id="cb29-9" data-line-number="9">getBufferByteCount</a>
<a class="sourceLine" id="cb29-10" data-line-number="10"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb29-11" data-line-number="11">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb29-12" data-line-number="12">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb29-13" data-line-number="13">getBufferByteCount (<span class="dt">Buffer</span> buf _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb29-14" data-line-number="14">  <span class="kw">let</span> m <span class="fu">=</span> value<span class="ot"> buf ::</span> <span class="dt">MeasureText</span> w t d <span class="kw">in</span></a>
<a class="sourceLine" id="cb29-15" data-line-number="15">  byteCount m</a>
<a class="sourceLine" id="cb29-16" data-line-number="16"></a>
<a class="sourceLine" id="cb29-17" data-line-number="17">getBufferLineCol</a>
<a class="sourceLine" id="cb29-18" data-line-number="18"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb29-19" data-line-number="19">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb29-20" data-line-number="20">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">LineCol</span></a>
<a class="sourceLine" id="cb29-21" data-line-number="21">getBufferLineCol buf <span class="fu">=</span></a>
<a class="sourceLine" id="cb29-22" data-line-number="22">  <span class="kw">let</span> m <span class="fu">=</span> value<span class="ot"> buf ::</span> <span class="dt">MeasureText</span> w t d <span class="kw">in</span></a>
<a class="sourceLine" id="cb29-23" data-line-number="23">  logicalCoords m</a>
<a class="sourceLine" id="cb29-24" data-line-number="24"></a>
<a class="sourceLine" id="cb29-25" data-line-number="25">getBufferScreenCoords</a>
<a class="sourceLine" id="cb29-26" data-line-number="26"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb29-27" data-line-number="27">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb29-28" data-line-number="28">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb29-29" data-line-number="29">getBufferScreenCoords (<span class="dt">Buffer</span> buf _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb29-30" data-line-number="30">  <span class="kw">let</span> m <span class="fu">=</span> value<span class="ot"> buf ::</span> <span class="dt">MeasureText</span> w t d <span class="kw">in</span></a>
<a class="sourceLine" id="cb29-31" data-line-number="31">  applyScreenOffset (screenCoords m) (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb29-32" data-line-number="32"></a>
<a class="sourceLine" id="cb29-33" data-line-number="33">getBufferScreenOffset</a>
<a class="sourceLine" id="cb29-34" data-line-number="34"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb29-35" data-line-number="35">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb29-36" data-line-number="36">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb29-37" data-line-number="37">getBufferScreenOffset (<span class="dt">Buffer</span> buf _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb29-38" data-line-number="38">  <span class="kw">let</span> m <span class="fu">=</span> value<span class="ot"> buf ::</span> <span class="dt">MeasureText</span> w t d <span class="kw">in</span></a>
<a class="sourceLine" id="cb29-39" data-line-number="39">  applyScreenOffset (screenCoords m <span class="fu">&lt;&gt;</span> screenOffset m) (<span class="dv">0</span>,<span class="dv">0</span>)</a></code></pre></div>
<p>Likewise we can query the value at the point.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb30-1" data-line-number="1">getPointCharCount</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb30-4" data-line-number="4">getPointCharCount (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb30-5" data-line-number="5">  <span class="kw">case</span> TPL.valueUpToPoint w <span class="kw">of</span></a>
<a class="sourceLine" id="cb30-6" data-line-number="6">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb30-7" data-line-number="7">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> charCount m</a>
<a class="sourceLine" id="cb30-8" data-line-number="8"></a>
<a class="sourceLine" id="cb30-9" data-line-number="9">getPointByteCount</a>
<a class="sourceLine" id="cb30-10" data-line-number="10"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb30-11" data-line-number="11">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb30-12" data-line-number="12">getPointByteCount (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb30-13" data-line-number="13">  <span class="kw">case</span> TPL.valueUpToPoint w <span class="kw">of</span></a>
<a class="sourceLine" id="cb30-14" data-line-number="14">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb30-15" data-line-number="15">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> byteCount m</a>
<a class="sourceLine" id="cb30-16" data-line-number="16"></a>
<a class="sourceLine" id="cb30-17" data-line-number="17">getPointLineCol</a>
<a class="sourceLine" id="cb30-18" data-line-number="18"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb30-19" data-line-number="19">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb30-20" data-line-number="20">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">LineCol</span></a>
<a class="sourceLine" id="cb30-21" data-line-number="21">getPointLineCol (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb30-22" data-line-number="22">  <span class="kw">case</span> TPL.valueUpToPoint w <span class="kw">of</span></a>
<a class="sourceLine" id="cb30-23" data-line-number="23">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> mempty</a>
<a class="sourceLine" id="cb30-24" data-line-number="24">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> logicalCoords m</a>
<a class="sourceLine" id="cb30-25" data-line-number="25"> </a>
<a class="sourceLine" id="cb30-26" data-line-number="26">getPointScreenCoords</a>
<a class="sourceLine" id="cb30-27" data-line-number="27"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb30-28" data-line-number="28">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb30-29" data-line-number="29">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb30-30" data-line-number="30">getPointScreenCoords (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb30-31" data-line-number="31">  <span class="kw">case</span> TPL.valueUpToPoint w <span class="kw">of</span></a>
<a class="sourceLine" id="cb30-32" data-line-number="32">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb30-33" data-line-number="33">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> applyScreenOffset (screenCoords m) (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb30-34" data-line-number="34"></a>
<a class="sourceLine" id="cb30-35" data-line-number="35">getPointScreenOffset</a>
<a class="sourceLine" id="cb30-36" data-line-number="36"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb30-37" data-line-number="37">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb30-38" data-line-number="38">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb30-39" data-line-number="39">getPointScreenOffset (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb30-40" data-line-number="40">  <span class="kw">case</span> TPL.valueUpToPoint w <span class="kw">of</span></a>
<a class="sourceLine" id="cb30-41" data-line-number="41">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb30-42" data-line-number="42">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> applyScreenOffset (screenCoords m <span class="fu">&lt;&gt;</span> screenOffset m) (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb30-43" data-line-number="43"></a>
<a class="sourceLine" id="cb30-44" data-line-number="44">getPointRuneId</a>
<a class="sourceLine" id="cb30-45" data-line-number="45"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb30-46" data-line-number="46">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb30-47" data-line-number="47">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Augmented</span> (<span class="dt">RuneId</span> d)</a>
<a class="sourceLine" id="cb30-48" data-line-number="48">getPointRuneId (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb30-49" data-line-number="49">  <span class="kw">case</span> TPL.valueBeforePoint w <span class="kw">of</span></a>
<a class="sourceLine" id="cb30-50" data-line-number="50">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Infimum</span></a>
<a class="sourceLine" id="cb30-51" data-line-number="51">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> runeId m</a></code></pre></div>
<p>And for good measure, at the mark as well.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb31-1" data-line-number="1">getMarkCharCount</a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4">getMarkCharCount (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5">  <span class="kw">case</span> TPL.valueUpToMark w <span class="kw">of</span></a>
<a class="sourceLine" id="cb31-6" data-line-number="6">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> charCount m</a>
<a class="sourceLine" id="cb31-8" data-line-number="8"></a>
<a class="sourceLine" id="cb31-9" data-line-number="9">getMarkByteCount</a>
<a class="sourceLine" id="cb31-10" data-line-number="10"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb31-11" data-line-number="11">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb31-12" data-line-number="12">getMarkByteCount (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb31-13" data-line-number="13">  <span class="kw">case</span> TPL.valueUpToMark w <span class="kw">of</span></a>
<a class="sourceLine" id="cb31-14" data-line-number="14">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb31-15" data-line-number="15">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> byteCount m</a>
<a class="sourceLine" id="cb31-16" data-line-number="16"></a>
<a class="sourceLine" id="cb31-17" data-line-number="17">getMarkLineCol</a>
<a class="sourceLine" id="cb31-18" data-line-number="18"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb31-19" data-line-number="19">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb31-20" data-line-number="20">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">LineCol</span></a>
<a class="sourceLine" id="cb31-21" data-line-number="21">getMarkLineCol (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb31-22" data-line-number="22">  <span class="kw">case</span> TPL.valueUpToMark w <span class="kw">of</span></a>
<a class="sourceLine" id="cb31-23" data-line-number="23">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> mempty</a>
<a class="sourceLine" id="cb31-24" data-line-number="24">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> logicalCoords m</a>
<a class="sourceLine" id="cb31-25" data-line-number="25"> </a>
<a class="sourceLine" id="cb31-26" data-line-number="26">getMarkScreenCoords</a>
<a class="sourceLine" id="cb31-27" data-line-number="27"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb31-28" data-line-number="28">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb31-29" data-line-number="29">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb31-30" data-line-number="30">getMarkScreenCoords (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb31-31" data-line-number="31">  <span class="kw">case</span> TPL.valueUpToMark w <span class="kw">of</span></a>
<a class="sourceLine" id="cb31-32" data-line-number="32">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb31-33" data-line-number="33">    <span class="dt">Just</span> m <span class="ot">-&gt;</span> applyScreenOffset (screenCoords m) (<span class="dv">0</span>,<span class="dv">0</span>)</a></code></pre></div>
</section>
<section id="splitting" class="level2">
<h2>Splitting</h2>
<p>Recall that finger trees, the structure underlying our buffers, admit an efficient <em>splitting</em> operation, which we can take advantage of to move the point and mark to specific locations in the buffer. First we define a utility function, not exposed outside this module, that attempts to split a buffer on an arbitrary predicate.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb32-1" data-line-number="1">movePoint</a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb32-3" data-line-number="3">  <span class="ot">=&gt;</span> (<span class="dt">MeasureText</span> w t d <span class="ot">-&gt;</span> <span class="dt">Bool</span>)</a>
<a class="sourceLine" id="cb32-4" data-line-number="4">  <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb32-5" data-line-number="5">movePoint pointP (<span class="dt">Buffer</span> w r) <span class="fu">=</span></a>
<a class="sourceLine" id="cb32-6" data-line-number="6">  <span class="dt">Buffer</span> <span class="fu">&lt;$&gt;</span> TPL.splitPoint pointP w <span class="fu">&lt;*&gt;</span> pure r</a></code></pre></div>
<p>For ergonomics’ sake we’ll expose specialized splitting functions. First at a given line and column position:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb33-1" data-line-number="1">movePointToLineCol</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a )</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">LineCol</span> <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">movePointToLineCol lc buf <span class="fu">=</span></a>
<a class="sourceLine" id="cb33-5" data-line-number="5">  <span class="kw">case</span> movePoint (atOrAfterLineCol lc) buf <span class="kw">of</span></a>
<a class="sourceLine" id="cb33-6" data-line-number="6">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> movePointToEnd buf</a>
<a class="sourceLine" id="cb33-7" data-line-number="7">    <span class="dt">Just</span> xs <span class="ot">-&gt;</span> xs</a>
<a class="sourceLine" id="cb33-8" data-line-number="8"></a>
<a class="sourceLine" id="cb33-9" data-line-number="9">atOrAfterLineCol</a>
<a class="sourceLine" id="cb33-10" data-line-number="10"><span class="ot">  ::</span> <span class="dt">LineCol</span> <span class="ot">-&gt;</span> <span class="dt">MeasureText</span> w t d <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb33-11" data-line-number="11">atOrAfterLineCol lc m <span class="fu">=</span></a>
<a class="sourceLine" id="cb33-12" data-line-number="12">  lc <span class="fu">&lt;</span> (logicalCoords m) <span class="fu">&lt;&gt;</span> (logicalOffset m)</a></code></pre></div>
<p>We should also test some simple cases to make sure we understand how this splitting works.</p>
<div class="doctest">
<div class="sourceCode" id="cb34"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb34-4" data-line-number="4"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb34-5" data-line-number="5"><span class="co">--     &quot;abc\nd&quot; &#39;e&#39; &quot;f\nghi&quot;</span></a>
<a class="sourceLine" id="cb34-6" data-line-number="6"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb34-7" data-line-number="7"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;bc\ndef\nghi&quot;</span></a>
<a class="sourceLine" id="cb34-8" data-line-number="8"><span class="co">-- in y == movePointToLineCol (LineCol 0 0) x</span></a>
<a class="sourceLine" id="cb34-9" data-line-number="9"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb34-10" data-line-number="10"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb34-11" data-line-number="11"><span class="co">--</span></a>
<a class="sourceLine" id="cb34-12" data-line-number="12"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb34-13" data-line-number="13"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb34-14" data-line-number="14"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10  (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb34-15" data-line-number="15"><span class="co">--     &quot;abc\nd&quot; &#39;e&#39; &quot;f\nghi&quot;</span></a>
<a class="sourceLine" id="cb34-16" data-line-number="16"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb34-17" data-line-number="17"><span class="co">--     &quot;abc\ndef\ng&quot; &#39;h&#39; &quot;i&quot;</span></a>
<a class="sourceLine" id="cb34-18" data-line-number="18"><span class="co">-- in y == movePointToLineCol (LineCol 2 1) x</span></a>
<a class="sourceLine" id="cb34-19" data-line-number="19"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb34-20" data-line-number="20"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb34-21" data-line-number="21"><span class="co">--</span></a>
<a class="sourceLine" id="cb34-22" data-line-number="22"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb34-23" data-line-number="23"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb34-24" data-line-number="24"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb34-25" data-line-number="25"><span class="co">--     &quot;abc\nd&quot; &#39;e&#39; &quot;f\nghi&quot;</span></a>
<a class="sourceLine" id="cb34-26" data-line-number="26"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb34-27" data-line-number="27"><span class="co">--     &quot;abc&quot; &#39;\n&#39; &quot;def\nghi&quot;</span></a>
<a class="sourceLine" id="cb34-28" data-line-number="28"><span class="co">-- in y == movePointToLineCol (LineCol 0 4) x</span></a>
<a class="sourceLine" id="cb34-29" data-line-number="29"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb34-30" data-line-number="30"><span class="co">-- True</span></a></code></pre></div>
</div>
<p>Next we’d like to split at a given pair of screen coordinates. It’s straightforward how this should work if we try to split at a pair of coordinates corresponding to a character in the buffer (split there). It’s also (slightly less but still fairly) straightforward how to handle coordinates that fall off the end of the buffer; we’ll just clamp them to the EOF sigil. But there’s a universe of pairs whose <span class="math inline">\(y\)</span> coordinates correspond to <em>lines</em> on the screen, but whose <span class="math inline">\(x\)</span> coordinates march off the right edge. What should these do?</p>
<p>One option is to just fail. But I think a better option is to try our best to return a reasonable result: in this case, to move the point to the last position on the screen line. In some sense that is “as close as we can get” in this case.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb35-1" data-line-number="1">movePointToScreenCoords</a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a )</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">  <span class="ot">=&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb35-5" data-line-number="5">movePointToScreenCoords pos buf <span class="fu">=</span></a>
<a class="sourceLine" id="cb35-6" data-line-number="6">  <span class="kw">if</span> pos <span class="fu">==</span> (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb35-7" data-line-number="7">    <span class="kw">then</span> movePointToStart buf</a>
<a class="sourceLine" id="cb35-8" data-line-number="8">    <span class="kw">else</span> <span class="kw">case</span> movePoint (atOrAfterScreenCoords pos) buf <span class="kw">of</span></a>
<a class="sourceLine" id="cb35-9" data-line-number="9">      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> movePointToEnd buf</a>
<a class="sourceLine" id="cb35-10" data-line-number="10">      <span class="dt">Just</span> xs <span class="ot">-&gt;</span> xs</a>
<a class="sourceLine" id="cb35-11" data-line-number="11"></a>
<a class="sourceLine" id="cb35-12" data-line-number="12">atOrAfterScreenCoords</a>
<a class="sourceLine" id="cb35-13" data-line-number="13"><span class="ot">  ::</span> forall w t d</a>
<a class="sourceLine" id="cb35-14" data-line-number="14">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d )</a>
<a class="sourceLine" id="cb35-15" data-line-number="15">  <span class="ot">=&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">MeasureText</span> w t d <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb35-16" data-line-number="16">atOrAfterScreenCoords (u,v) m <span class="fu">=</span></a>
<a class="sourceLine" id="cb35-17" data-line-number="17">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb35-18" data-line-number="18">    (h,k) <span class="fu">=</span> applyScreenOffset (screenCoords m <span class="fu">&lt;&gt;</span> screenOffset m) (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb35-19" data-line-number="19">  <span class="kw">in</span> (v <span class="fu">&lt;</span> k) <span class="fu">||</span> ((v <span class="fu">==</span> k) <span class="fu">&amp;&amp;</span> (u <span class="fu">&lt;</span> h))</a></code></pre></div>
<p>We can test our understanding with some examples.</p>
<div class="doctest">
<div class="sourceCode" id="cb36"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-5" data-line-number="5"><span class="co">--     &quot;abc\nde&quot; &#39;f&#39; &quot;\nghi&quot;</span></a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-7" data-line-number="7"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;bc\ndef\nghi&quot;</span></a>
<a class="sourceLine" id="cb36-8" data-line-number="8"><span class="co">-- in y == movePointToScreenCoords (0,0) x</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb36-10" data-line-number="10"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb36-11" data-line-number="11"><span class="co">--</span></a>
<a class="sourceLine" id="cb36-12" data-line-number="12"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb36-13" data-line-number="13"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb36-14" data-line-number="14"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-15" data-line-number="15"><span class="co">--     &quot;abc\nde&quot; &#39;f&#39; &quot;\nghi&quot;</span></a>
<a class="sourceLine" id="cb36-16" data-line-number="16"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-17" data-line-number="17"><span class="co">--     &quot;a&quot; &#39;b&#39; &quot;c\ndef\nghi&quot;</span></a>
<a class="sourceLine" id="cb36-18" data-line-number="18"><span class="co">-- in y == movePointToScreenCoords (1,0) x</span></a>
<a class="sourceLine" id="cb36-19" data-line-number="19"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb36-20" data-line-number="20"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb36-21" data-line-number="21"><span class="co">--</span></a>
<a class="sourceLine" id="cb36-22" data-line-number="22"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb36-23" data-line-number="23"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb36-24" data-line-number="24"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-25" data-line-number="25"><span class="co">--     &quot;abc\ndefg&quot; &#39;h&#39; &quot;i\njkl&quot;</span></a>
<a class="sourceLine" id="cb36-26" data-line-number="26"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-27" data-line-number="27"><span class="co">--     &quot;abc\nde&quot; &#39;f&#39; &quot;ghi\njkl&quot;</span></a>
<a class="sourceLine" id="cb36-28" data-line-number="28"><span class="co">-- in y == movePointToScreenCoords (2,1) x</span></a>
<a class="sourceLine" id="cb36-29" data-line-number="29"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb36-30" data-line-number="30"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb36-31" data-line-number="31"><span class="co">--</span></a>
<a class="sourceLine" id="cb36-32" data-line-number="32"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb36-33" data-line-number="33"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb36-34" data-line-number="34"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-35" data-line-number="35"><span class="co">--     &quot;ab&quot; &#39;c&#39; &quot;defgh&quot;</span></a>
<a class="sourceLine" id="cb36-36" data-line-number="36"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-37" data-line-number="37"><span class="co">--     &quot;abcdefg&quot; &#39;h&#39; &quot;&quot;</span></a>
<a class="sourceLine" id="cb36-38" data-line-number="38"><span class="co">-- in y == movePointToScreenCoords (7,0) x</span></a>
<a class="sourceLine" id="cb36-39" data-line-number="39"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb36-40" data-line-number="40"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb36-41" data-line-number="41"><span class="co">--</span></a>
<a class="sourceLine" id="cb36-42" data-line-number="42"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb36-43" data-line-number="43"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb36-44" data-line-number="44"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-45" data-line-number="45"><span class="co">--     &quot;ab&quot; &#39;c&#39; &quot;defghijklmnop&quot;</span></a>
<a class="sourceLine" id="cb36-46" data-line-number="46"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-47" data-line-number="47"><span class="co">--     &quot;abcdefghij&quot; &#39;k&#39; &quot;lmnop&quot;</span></a>
<a class="sourceLine" id="cb36-48" data-line-number="48"><span class="co">-- in y == movePointToScreenCoords (2,1) x</span></a>
<a class="sourceLine" id="cb36-49" data-line-number="49"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb36-50" data-line-number="50"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb36-51" data-line-number="51"><span class="co">--</span></a>
<a class="sourceLine" id="cb36-52" data-line-number="52"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb36-53" data-line-number="53"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb36-54" data-line-number="54"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-55" data-line-number="55"><span class="co">--     &quot;abc\nde\nf&quot; &#39;g&#39; &quot;h&quot;</span></a>
<a class="sourceLine" id="cb36-56" data-line-number="56"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-57" data-line-number="57"><span class="co">--     &quot;abc\nde&quot; &#39;\n&#39; &quot;fgh&quot;</span></a>
<a class="sourceLine" id="cb36-58" data-line-number="58"><span class="co">-- in y == movePointToScreenCoords (5,1) x</span></a>
<a class="sourceLine" id="cb36-59" data-line-number="59"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb36-60" data-line-number="60"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb36-61" data-line-number="61"><span class="co">--</span></a>
<a class="sourceLine" id="cb36-62" data-line-number="62"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb36-63" data-line-number="63"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb36-64" data-line-number="64"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-65" data-line-number="65"><span class="co">--     &quot;abcdefghijklmn&quot; &#39;o&#39; &quot;pqrst&quot;</span></a>
<a class="sourceLine" id="cb36-66" data-line-number="66"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb36-67" data-line-number="67"><span class="co">--     &quot;abcdefg&quot; &#39;h&#39; &quot;ijklmnopqrst&quot;</span></a>
<a class="sourceLine" id="cb36-68" data-line-number="68"><span class="co">-- in y == movePointToScreenCoords (10,0) x</span></a>
<a class="sourceLine" id="cb36-69" data-line-number="69"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb36-70" data-line-number="70"><span class="co">-- True</span></a></code></pre></div>
</div>
<p>Next we define a utility which moves the point to the first character of a given screen line – which is crucial for rendering buffers to the screen. This is a little trickier than moving to a specific line and character or pair of screen coordinates, because it involves a <em>relative</em> position and nailing down exactly what it means to say that a character is at the start of a new screen line.</p>
<p>Suppose the final screen coordinate in the buffer is <span class="math inline">\((W,H)\)</span> and we want to move to the first position of screen line <span class="math inline">\(y\)</span>. If <span class="math inline">\(y\)</span> is in the interval <span class="math inline">\([0,H]\)</span>, then some character has screen coordinate <span class="math inline">\((0,y)\)</span> and we can find it with an ordinary split. Similarly simple, if <span class="math inline">\(y\)</span> is at least <span class="math inline">\(H+2\)</span> then no such character exists, and the EOF sigil can’t help us. The delicate case is when we want to move to the first position of screen line <span class="math inline">\(H+1\)</span>. This case depends on (1) the final character in the buffer and (2) the width of the final screen line in the buffer (that is, <span class="math inline">\(W\)</span>). If the final character is a newline, we’d like to consider the EOF sigil to be the start of the next screen line. If the final character is not a newline, then we consider the EOF sigil to be on the last line (not the start of the next line) <em>unless</em> the final character’s effective width plus <span class="math inline">\(W\)</span> exceeds the screen width.</p>
<p>That’s a mouthful!</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb37-1" data-line-number="1">movePointToScreenLine</a>
<a class="sourceLine" id="cb37-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb37-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb37-5" data-line-number="5">movePointToScreenLine k buf <span class="fu">=</span></a>
<a class="sourceLine" id="cb37-6" data-line-number="6">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb37-7" data-line-number="7">    (_,h) <span class="fu">=</span> getBufferScreenOffset buf</a>
<a class="sourceLine" id="cb37-8" data-line-number="8">    bW <span class="fu">=</span> toWidth (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> w)</a>
<a class="sourceLine" id="cb37-9" data-line-number="9">  <span class="kw">in</span> <span class="kw">if</span> k <span class="fu">&gt;</span> <span class="dv">1</span> <span class="fu">+</span> h</a>
<a class="sourceLine" id="cb37-10" data-line-number="10">    <span class="kw">then</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb37-11" data-line-number="11">    <span class="kw">else</span> <span class="kw">if</span> k <span class="fu">&lt;=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb37-12" data-line-number="12">      <span class="kw">then</span> <span class="dt">Just</span> <span class="fu">$</span> movePointToStart buf</a>
<a class="sourceLine" id="cb37-13" data-line-number="13">      <span class="kw">else</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb37-14" data-line-number="14">        z <span class="ot">&lt;-</span> movePoint (atOrAfterScreenLine k) buf</a>
<a class="sourceLine" id="cb37-15" data-line-number="15">        <span class="kw">let</span></a>
<a class="sourceLine" id="cb37-16" data-line-number="16">          (u,v) <span class="fu">=</span> getPointScreenOffset z</a>
<a class="sourceLine" id="cb37-17" data-line-number="17">        <span class="kw">if</span> (k <span class="fu">&lt;</span> <span class="dv">1</span> <span class="fu">+</span> h) <span class="fu">||</span> ((v <span class="fu">==</span> <span class="dv">1</span> <span class="fu">+</span> h) <span class="fu">&amp;&amp;</span> ((u <span class="fu">==</span> bW <span class="fu">-</span> <span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb37-18" data-line-number="18">          <span class="kw">then</span> <span class="dt">Just</span> z</a>
<a class="sourceLine" id="cb37-19" data-line-number="19">          <span class="kw">else</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb37-20" data-line-number="20"></a>
<a class="sourceLine" id="cb37-21" data-line-number="21">atOrAfterScreenLine</a>
<a class="sourceLine" id="cb37-22" data-line-number="22"><span class="ot">  ::</span> forall w t d</a>
<a class="sourceLine" id="cb37-23" data-line-number="23">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d )</a>
<a class="sourceLine" id="cb37-24" data-line-number="24">  <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">MeasureText</span> w t d <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb37-25" data-line-number="25">atOrAfterScreenLine k m <span class="fu">=</span></a>
<a class="sourceLine" id="cb37-26" data-line-number="26">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb37-27" data-line-number="27">    offset <span class="fu">=</span> (screenCoords m) <span class="fu">&lt;&gt;</span> (screenOffset m)</a>
<a class="sourceLine" id="cb37-28" data-line-number="28">    (u,v) <span class="fu">=</span> applyScreenOffset offset (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb37-29" data-line-number="29">  <span class="kw">in</span> (v <span class="fu">&gt;</span> k) <span class="fu">||</span> ((v <span class="fu">==</span> k) <span class="fu">&amp;&amp;</span> (u <span class="fu">&gt;=</span> <span class="dv">1</span>)) <span class="fu">||</span> (hasEOF m)</a></code></pre></div>
<p>And some example cases:</p>
<div class="doctest">
<div class="sourceCode" id="cb38"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="co">-- Split at line 0 &lt; h</span></a>
<a class="sourceLine" id="cb38-3" data-line-number="3"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb38-4" data-line-number="4"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb38-5" data-line-number="5"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-6" data-line-number="6"><span class="co">--     &quot;abc\nde&quot; &#39;f&#39; &quot;\nghi&quot;</span></a>
<a class="sourceLine" id="cb38-7" data-line-number="7"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-8" data-line-number="8"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;bc\ndef\nghi&quot;</span></a>
<a class="sourceLine" id="cb38-9" data-line-number="9"><span class="co">-- in Just y == movePointToScreenLine 0 x</span></a>
<a class="sourceLine" id="cb38-10" data-line-number="10"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb38-11" data-line-number="11"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb38-12" data-line-number="12"><span class="co">--</span></a>
<a class="sourceLine" id="cb38-13" data-line-number="13"><span class="co">-- Split at line 1 &lt; h</span></a>
<a class="sourceLine" id="cb38-14" data-line-number="14"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb38-15" data-line-number="15"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb38-16" data-line-number="16"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-17" data-line-number="17"><span class="co">--     &quot;abc\nde\nf&quot; &#39;g&#39; &quot;h&quot;</span></a>
<a class="sourceLine" id="cb38-18" data-line-number="18"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-19" data-line-number="19"><span class="co">--     &quot;abc\n&quot; &#39;d&#39; &quot;e\nfgh&quot;</span></a>
<a class="sourceLine" id="cb38-20" data-line-number="20"><span class="co">-- in Just y == movePointToScreenLine 1 x</span></a>
<a class="sourceLine" id="cb38-21" data-line-number="21"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb38-22" data-line-number="22"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb38-23" data-line-number="23"><span class="co">--</span></a>
<a class="sourceLine" id="cb38-24" data-line-number="24"><span class="co">-- Split at line 2 &lt; h</span></a>
<a class="sourceLine" id="cb38-25" data-line-number="25"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb38-26" data-line-number="26"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb38-27" data-line-number="27"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-28" data-line-number="28"><span class="co">--     &quot;abc\n&quot; &#39;d&#39; &quot;e\nfgh&quot;</span></a>
<a class="sourceLine" id="cb38-29" data-line-number="29"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-30" data-line-number="30"><span class="co">--     &quot;abc\nde\n&quot; &#39;f&#39; &quot;gh&quot;</span></a>
<a class="sourceLine" id="cb38-31" data-line-number="31"><span class="co">-- in Just y == movePointToScreenLine 2 x</span></a>
<a class="sourceLine" id="cb38-32" data-line-number="32"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb38-33" data-line-number="33"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb38-34" data-line-number="34"><span class="co">--</span></a>
<a class="sourceLine" id="cb38-35" data-line-number="35"><span class="co">-- Split at line h+1 (last cell is an interior char)</span></a>
<a class="sourceLine" id="cb38-36" data-line-number="36"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb38-37" data-line-number="37"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb38-38" data-line-number="38"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-39" data-line-number="39"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;&quot;</span></a>
<a class="sourceLine" id="cb38-40" data-line-number="40"><span class="co">-- in Nothing == movePointToScreenLine 1 x</span></a>
<a class="sourceLine" id="cb38-41" data-line-number="41"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb38-42" data-line-number="42"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb38-43" data-line-number="43"><span class="co">--</span></a>
<a class="sourceLine" id="cb38-44" data-line-number="44"><span class="co">-- Split at line h+1 (last cell is a newline)</span></a>
<a class="sourceLine" id="cb38-45" data-line-number="45"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb38-46" data-line-number="46"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb38-47" data-line-number="47"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-48" data-line-number="48"><span class="co">--     &quot;&quot; &#39;\n&#39; &quot;&quot;</span></a>
<a class="sourceLine" id="cb38-49" data-line-number="49"><span class="co">--   y = movePointToEnd x</span></a>
<a class="sourceLine" id="cb38-50" data-line-number="50"><span class="co">-- in Just y == movePointToScreenLine 1 x</span></a>
<a class="sourceLine" id="cb38-51" data-line-number="51"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb38-52" data-line-number="52"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb38-53" data-line-number="53"><span class="co">--</span></a>
<a class="sourceLine" id="cb38-54" data-line-number="54"><span class="co">-- Split at line h+1 (last cell is an end char)</span></a>
<a class="sourceLine" id="cb38-55" data-line-number="55"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb38-56" data-line-number="56"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb38-57" data-line-number="57"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-58" data-line-number="58"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;aaaaaaa&quot;</span></a>
<a class="sourceLine" id="cb38-59" data-line-number="59"><span class="co">--   y = movePointToEnd x</span></a>
<a class="sourceLine" id="cb38-60" data-line-number="60"><span class="co">-- in Just y == movePointToScreenLine 1 x</span></a>
<a class="sourceLine" id="cb38-61" data-line-number="61"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb38-62" data-line-number="62"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb38-63" data-line-number="63"><span class="co">--</span></a>
<a class="sourceLine" id="cb38-64" data-line-number="64"><span class="co">-- Split at line h+1 (last cell is an end tab)</span></a>
<a class="sourceLine" id="cb38-65" data-line-number="65"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb38-66" data-line-number="66"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb38-67" data-line-number="67"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-68" data-line-number="68"><span class="co">--     &quot;&quot; &#39;\t&#39; &quot;\t\t\t&quot;</span></a>
<a class="sourceLine" id="cb38-69" data-line-number="69"><span class="co">--   y = movePointToEnd x</span></a>
<a class="sourceLine" id="cb38-70" data-line-number="70"><span class="co">-- in Just y == movePointToScreenLine 1 x</span></a>
<a class="sourceLine" id="cb38-71" data-line-number="71"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb38-72" data-line-number="72"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb38-73" data-line-number="73"><span class="co">--</span></a>
<a class="sourceLine" id="cb38-74" data-line-number="74"><span class="co">-- Split at line 1 == h (last cell is a newline)</span></a>
<a class="sourceLine" id="cb38-75" data-line-number="75"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb38-76" data-line-number="76"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb38-77" data-line-number="77"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-78" data-line-number="78"><span class="co">--     &quot;&quot; &#39;\n&#39; &quot;\n&quot;</span></a>
<a class="sourceLine" id="cb38-79" data-line-number="79"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb38-80" data-line-number="80"><span class="co">--     &quot;\n&quot; &#39;\n&#39; &quot;&quot;</span></a>
<a class="sourceLine" id="cb38-81" data-line-number="81"><span class="co">-- in Just y == movePointToScreenLine 1 x</span></a>
<a class="sourceLine" id="cb38-82" data-line-number="82"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb38-83" data-line-number="83"><span class="co">-- True</span></a></code></pre></div>
</div>
<p>With <code>movePointToScreenCoords</code> in hand, we can also figure out the coordinates “nearest” to a given pair which actually appear in the buffer.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb39-1" data-line-number="1">seekScreenCoords</a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a )</a>
<a class="sourceLine" id="cb39-3" data-line-number="3">  <span class="ot">=&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb39-4" data-line-number="4">seekScreenCoords z <span class="fu">=</span></a>
<a class="sourceLine" id="cb39-5" data-line-number="5">  getPointScreenCoords <span class="fu">.</span> movePointToScreenCoords z</a></code></pre></div>
<p>And some tests for our intuition:</p>
<div class="doctest">
<div class="sourceCode" id="cb40"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb40-3" data-line-number="3"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb40-4" data-line-number="4"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb40-5" data-line-number="5"><span class="co">--     &quot;abc\nd&quot; &#39;e&#39; &quot;f\ngh&quot;</span></a>
<a class="sourceLine" id="cb40-6" data-line-number="6"><span class="co">-- in seekScreenCoords (0,0) x</span></a>
<a class="sourceLine" id="cb40-7" data-line-number="7"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb40-8" data-line-number="8"><span class="co">-- (0,0)</span></a>
<a class="sourceLine" id="cb40-9" data-line-number="9"><span class="co">--</span></a>
<a class="sourceLine" id="cb40-10" data-line-number="10"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb40-11" data-line-number="11"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb40-12" data-line-number="12"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb40-13" data-line-number="13"><span class="co">--     &quot;abc\nd&quot; &#39;e&#39; &quot;f\ngh&quot;</span></a>
<a class="sourceLine" id="cb40-14" data-line-number="14"><span class="co">-- in seekScreenCoords (2,0) x</span></a>
<a class="sourceLine" id="cb40-15" data-line-number="15"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb40-16" data-line-number="16"><span class="co">-- (2,0)</span></a>
<a class="sourceLine" id="cb40-17" data-line-number="17"><span class="co">--</span></a>
<a class="sourceLine" id="cb40-18" data-line-number="18"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb40-19" data-line-number="19"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb40-20" data-line-number="20"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb40-21" data-line-number="21"><span class="co">--     &quot;abc\nd&quot; &#39;e&#39; &quot;f\ngh&quot;</span></a>
<a class="sourceLine" id="cb40-22" data-line-number="22"><span class="co">-- in seekScreenCoords (3,0) x</span></a>
<a class="sourceLine" id="cb40-23" data-line-number="23"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb40-24" data-line-number="24"><span class="co">-- (3,0)</span></a>
<a class="sourceLine" id="cb40-25" data-line-number="25"><span class="co">--</span></a>
<a class="sourceLine" id="cb40-26" data-line-number="26"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb40-27" data-line-number="27"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb40-28" data-line-number="28"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb40-29" data-line-number="29"><span class="co">--     &quot;abc\nd&quot; &#39;e&#39; &quot;f\ngh&quot;</span></a>
<a class="sourceLine" id="cb40-30" data-line-number="30"><span class="co">-- in seekScreenCoords (4,0) x</span></a>
<a class="sourceLine" id="cb40-31" data-line-number="31"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb40-32" data-line-number="32"><span class="co">-- (3,0)</span></a></code></pre></div>
</div>
<p>Finally, we’ll also need to split the buffer at a given rune ID.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb41-1" data-line-number="1">movePointToRuneId</a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb41-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a )</a>
<a class="sourceLine" id="cb41-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Augmented</span> (<span class="dt">RuneId</span> d) <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb41-5" data-line-number="5">movePointToRuneId rId buf <span class="fu">=</span></a>
<a class="sourceLine" id="cb41-6" data-line-number="6">  <span class="kw">case</span> movePoint (atOrAfterRuneId rId) buf <span class="kw">of</span></a>
<a class="sourceLine" id="cb41-7" data-line-number="7">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> movePointToEnd buf</a>
<a class="sourceLine" id="cb41-8" data-line-number="8">    <span class="dt">Just</span> xs <span class="ot">-&gt;</span> xs</a>
<a class="sourceLine" id="cb41-9" data-line-number="9"></a>
<a class="sourceLine" id="cb41-10" data-line-number="10">atOrAfterRuneId</a>
<a class="sourceLine" id="cb41-11" data-line-number="11"><span class="ot">  ::</span> forall w t d</a>
<a class="sourceLine" id="cb41-12" data-line-number="12">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d )</a>
<a class="sourceLine" id="cb41-13" data-line-number="13">  <span class="ot">=&gt;</span> <span class="dt">Augmented</span> (<span class="dt">RuneId</span> d) <span class="ot">-&gt;</span> <span class="dt">MeasureText</span> w t d <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb41-14" data-line-number="14">atOrAfterRuneId rId m <span class="fu">=</span></a>
<a class="sourceLine" id="cb41-15" data-line-number="15">  rId <span class="fu">&lt;</span> (runeId m)</a></code></pre></div>
<p>And with this splitting in hand, we can apply reified buffer operations.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb42-1" data-line-number="1">applyBufferOp</a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb42-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsChar</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb42-4" data-line-number="4">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">Ord</span> a )</a>
<a class="sourceLine" id="cb42-5" data-line-number="5">  <span class="ot">=&gt;</span> <span class="dt">BufferOp</span> d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb42-6" data-line-number="6">applyBufferOp op buf <span class="fu">=</span> <span class="kw">case</span> op <span class="kw">of</span></a>
<a class="sourceLine" id="cb42-7" data-line-number="7">  <span class="dt">BufferNoOp</span> <span class="ot">-&gt;</span> buf</a>
<a class="sourceLine" id="cb42-8" data-line-number="8"></a>
<a class="sourceLine" id="cb42-9" data-line-number="9">  <span class="dt">BufferOpIns</span> rune <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb42-10" data-line-number="10">    <span class="kw">if</span> RBT.member rune (bufRemnants buf)</a>
<a class="sourceLine" id="cb42-11" data-line-number="11">      <span class="kw">then</span> buf</a>
<a class="sourceLine" id="cb42-12" data-line-number="12">      <span class="kw">else</span></a>
<a class="sourceLine" id="cb42-13" data-line-number="13">        <span class="kw">let</span></a>
<a class="sourceLine" id="cb42-14" data-line-number="14">          buf&#39; <span class="fu">=</span> movePointToRuneId (<span class="dt">Augmented</span> (getRuneId rune)) buf</a>
<a class="sourceLine" id="cb42-15" data-line-number="15">          pId <span class="fu">=</span> getPointRuneId buf&#39;</a>
<a class="sourceLine" id="cb42-16" data-line-number="16">          <span class="dt">Buffer</span> contents remnants <span class="fu">=</span> buf&#39;</a>
<a class="sourceLine" id="cb42-17" data-line-number="17">        <span class="kw">in</span> <span class="kw">if</span> pId <span class="fu">==</span> <span class="dt">Augmented</span> (getRuneId rune)</a>
<a class="sourceLine" id="cb42-18" data-line-number="18">          <span class="kw">then</span> buf</a>
<a class="sourceLine" id="cb42-19" data-line-number="19">          <span class="kw">else</span> <span class="dt">Buffer</span> (TPL.insertPointLeft (<span class="dt">Cell</span> rune) contents) remnants</a>
<a class="sourceLine" id="cb42-20" data-line-number="20"></a>
<a class="sourceLine" id="cb42-21" data-line-number="21">  <span class="dt">BufferOpDel</span> rune <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb42-22" data-line-number="22">    <span class="kw">if</span> RBT.member rune (bufRemnants buf)</a>
<a class="sourceLine" id="cb42-23" data-line-number="23">      <span class="kw">then</span> buf</a>
<a class="sourceLine" id="cb42-24" data-line-number="24">      <span class="kw">else</span> </a>
<a class="sourceLine" id="cb42-25" data-line-number="25">        <span class="kw">let</span></a>
<a class="sourceLine" id="cb42-26" data-line-number="26">          buf&#39; <span class="fu">=</span> movePointToRuneId (<span class="dt">Augmented</span> (getRuneId rune)) buf</a>
<a class="sourceLine" id="cb42-27" data-line-number="27">          pId <span class="fu">=</span> getPointRuneId buf&#39;</a>
<a class="sourceLine" id="cb42-28" data-line-number="28">          <span class="dt">Buffer</span> contents remnants <span class="fu">=</span> buf&#39;</a>
<a class="sourceLine" id="cb42-29" data-line-number="29">        <span class="kw">in</span> <span class="kw">if</span> pId <span class="fu">/=</span> <span class="dt">Augmented</span> (getRuneId rune)</a>
<a class="sourceLine" id="cb42-30" data-line-number="30">          <span class="kw">then</span> <span class="dt">Buffer</span> contents (RBT.insert rune remnants)</a>
<a class="sourceLine" id="cb42-31" data-line-number="31">          <span class="kw">else</span> <span class="dt">Buffer</span> (TPL.deletePointLeft contents) (RBT.insert rune remnants)</a></code></pre></div>
<div class="doctest">
<div class="sourceCode" id="cb43"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb43-3" data-line-number="3"><span class="co">-- -- Delete and insert the same rune, but in different orders</span></a>
<a class="sourceLine" id="cb43-4" data-line-number="4"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb43-5" data-line-number="5"><span class="co">--   rune = newRuneId (EventId 0 &quot;foo&quot;) (Infimum, Supremum) &#39;a&#39;</span></a>
<a class="sourceLine" id="cb43-6" data-line-number="6"><span class="co">--   op1 = BufferOpDel rune</span></a>
<a class="sourceLine" id="cb43-7" data-line-number="7"><span class="co">--   op2 = BufferOpIns rune</span></a>
<a class="sourceLine" id="cb43-8" data-line-number="8"><span class="co">--   e = makeVacantBuffer nat8 nat2 nat3 (Proxy :: Proxy Char)</span></a>
<a class="sourceLine" id="cb43-9" data-line-number="9"><span class="co">--   zig = applyBufferOp op1 (applyBufferOp op2 e)</span></a>
<a class="sourceLine" id="cb43-10" data-line-number="10"><span class="co">--   zag = applyBufferOp op2 (applyBufferOp op1 e)</span></a>
<a class="sourceLine" id="cb43-11" data-line-number="11"><span class="co">-- in zig == zag</span></a>
<a class="sourceLine" id="cb43-12" data-line-number="12"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb43-13" data-line-number="13"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb43-14" data-line-number="14"><span class="co">--</span></a>
<a class="sourceLine" id="cb43-15" data-line-number="15"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb43-16" data-line-number="16"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb43-17" data-line-number="17"><span class="co">-- -- Delete and insert runes that differ only by a color in different orders</span></a>
<a class="sourceLine" id="cb43-18" data-line-number="18"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb43-19" data-line-number="19"><span class="co">--   rune1 = newRuneId (EventId 0 &quot;foo&quot;) (Infimum, Supremum) $</span></a>
<a class="sourceLine" id="cb43-20" data-line-number="20"><span class="co">--     Glyph &#39;A&#39; (gray24 0) (gray24 0)</span></a>
<a class="sourceLine" id="cb43-21" data-line-number="21"><span class="co">--   rune2 = newRuneId (EventId 0 &quot;foo&quot;) (Infimum, Supremum) $</span></a>
<a class="sourceLine" id="cb43-22" data-line-number="22"><span class="co">--     Glyph &#39;A&#39; (rgb6 0 0 0) (rgb6 0 0 0)</span></a>
<a class="sourceLine" id="cb43-23" data-line-number="23"><span class="co">--   op1 = BufferOpIns rune1</span></a>
<a class="sourceLine" id="cb43-24" data-line-number="24"><span class="co">--   op2 = BufferOpDel rune2</span></a>
<a class="sourceLine" id="cb43-25" data-line-number="25"><span class="co">--   e = makeVacantBuffer nat8 nat2 nat3 (Proxy :: Proxy (Glyph Char))</span></a>
<a class="sourceLine" id="cb43-26" data-line-number="26"><span class="co">--   zig = applyBufferOp op1 (applyBufferOp op2 e)</span></a>
<a class="sourceLine" id="cb43-27" data-line-number="27"><span class="co">--   zag = applyBufferOp op2 (applyBufferOp op1 e)</span></a>
<a class="sourceLine" id="cb43-28" data-line-number="28"><span class="co">-- in zig == zag</span></a>
<a class="sourceLine" id="cb43-29" data-line-number="29"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb43-30" data-line-number="30"><span class="co">-- True</span></a></code></pre></div>
</div>
</section>
<section id="rendering" class="level2">
<h2>Rendering</h2>
<p>Buffers are a data structure for storing and manipulating text, but they’re not very helpful for <em>viewing</em> the text. We’ll also need some code to convert the internal representation of a buffer into a format suitable for rendering on a screen.</p>
<p>We’re making a major simplifying assumption that comes in handy here: text will be drawn in a monospaced typeface, meaning we can pretend that the display window is divided into a rectangular grid of character positions and each character occupies a whole number of grid cells.</p>
<p>The buffer is naturally divided into <em>screen lines</em> – these are contiguous chunks of text that will render at the same <span class="math inline">\(y\)</span> coordinate. We’ve set up the <code>MeasureText</code> type so that these are easy to find. All but the last of these screen lines will be <em>full</em>, meaning that every cell is occupied (possibly by a newline or tab). The last screen line is not full; this is where the EOF sigil hangs out.</p>
<p>To flesh out the theory of buffers, we’ll include here a function which detects whether or not the buffer has a full screen line.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb44-1" data-line-number="1">hasFullScreenLine</a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb44-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb44-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5">hasFullScreenLine w <span class="fu">=</span></a>
<a class="sourceLine" id="cb44-6" data-line-number="6">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb44-7" data-line-number="7">    m <span class="fu">=</span> value<span class="ot"> w ::</span> <span class="dt">MeasureText</span> w t d</a>
<a class="sourceLine" id="cb44-8" data-line-number="8">    (_,h) <span class="fu">=</span> applyScreenOffset (screenCoords m <span class="fu">&lt;&gt;</span> screenOffset m) (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb44-9" data-line-number="9">  <span class="kw">in</span> h <span class="fu">&gt;</span> <span class="dv">0</span></a></code></pre></div>
<p>This function is primarily used in testing to help scaffold the consistency of our main rendering code. Here are some examples.</p>
<div class="doctest">
<div class="sourceCode" id="cb45"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb45-2" data-line-number="2"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb45-3" data-line-number="3"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;bc&quot;</span></a>
<a class="sourceLine" id="cb45-6" data-line-number="6"><span class="co">-- in hasFullScreenLine x</span></a>
<a class="sourceLine" id="cb45-7" data-line-number="7"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb45-8" data-line-number="8"><span class="co">-- False</span></a>
<a class="sourceLine" id="cb45-9" data-line-number="9"><span class="co">--</span></a>
<a class="sourceLine" id="cb45-10" data-line-number="10"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb45-11" data-line-number="11"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb45-12" data-line-number="12"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb45-13" data-line-number="13"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;bc\n&quot;</span></a>
<a class="sourceLine" id="cb45-14" data-line-number="14"><span class="co">-- in hasFullScreenLine x</span></a>
<a class="sourceLine" id="cb45-15" data-line-number="15"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb45-16" data-line-number="16"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb45-17" data-line-number="17"><span class="co">--</span></a>
<a class="sourceLine" id="cb45-18" data-line-number="18"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb45-19" data-line-number="19"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb45-20" data-line-number="20"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb45-21" data-line-number="21"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;bcdefgh&quot;</span></a>
<a class="sourceLine" id="cb45-22" data-line-number="22"><span class="co">-- in hasFullScreenLine x</span></a>
<a class="sourceLine" id="cb45-23" data-line-number="23"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb45-24" data-line-number="24"><span class="co">-- True</span></a></code></pre></div>
</div>
<p>To render the buffer we’ll first need to extract the visible screen lines. Working toward that goal, we’ll start with something simpler: extracting the <em>first</em> screen line from a buffer. Note the return type; we can always extract <em>something</em> from a valid buffer, even if it’s just the EOF sigil. The second entry in the return type indicates whether this happened – it’s <code>Nothing</code> if the EOF appears in the first entry, and <code>Just</code> otherwise.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb46-1" data-line-number="1">takeFirstScreenLine</a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb46-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb46-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb46-5" data-line-number="5">  <span class="ot">-&gt;</span> ( <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> a)</a>
<a class="sourceLine" id="cb46-6" data-line-number="6">     , <span class="dt">Maybe</span> (<span class="dt">Buffer</span> w t d a) )</a>
<a class="sourceLine" id="cb46-7" data-line-number="7">takeFirstScreenLine w <span class="fu">=</span></a>
<a class="sourceLine" id="cb46-8" data-line-number="8">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb46-9" data-line-number="9">    m <span class="fu">=</span> value<span class="ot"> w ::</span> <span class="dt">MeasureText</span> w t d</a>
<a class="sourceLine" id="cb46-10" data-line-number="10">    (_,h) <span class="fu">=</span> applyScreenOffset (screenCoords m <span class="fu">&lt;&gt;</span> screenOffset m) (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb46-11" data-line-number="11">  <span class="kw">in</span> <span class="kw">if</span> h <span class="fu">==</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb46-12" data-line-number="12">    <span class="kw">then</span> ( FT.fmapFT (fmap getRuneValue) <span class="fu">$</span> TPL.integrate <span class="fu">$</span> bufContents w, <span class="dt">Nothing</span>)</a>
<a class="sourceLine" id="cb46-13" data-line-number="13">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb46-14" data-line-number="14">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb46-15" data-line-number="15">        <span class="co">-- This pattern must match.</span></a>
<a class="sourceLine" id="cb46-16" data-line-number="16">        <span class="dt">Just</span> (<span class="dt">Buffer</span> (<span class="dt">TPL.PointOnly</span> (as, x, bs)) _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb46-17" data-line-number="17">          movePointToScreenLine <span class="dv">1</span> (clearMark w)</a>
<a class="sourceLine" id="cb46-18" data-line-number="18">      <span class="kw">in</span> ( FT.fmapFT (fmap getRuneValue) as, <span class="dt">Just</span> <span class="fu">$</span> <span class="dt">Buffer</span> (<span class="dt">TPL.PointOnly</span> (mempty, x, bs)) RBT.empty )</a></code></pre></div>
<p>It is crucial that we understand exactly how this function works, since the rest of the rendering code is built on it. Here are some examples covering some of the different ways a buffer can be populated.</p>
<div class="doctest">
<div class="sourceCode" id="cb47"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2"><span class="co">-- &gt;&gt;&gt; -- &#39;Normal&#39; text with a newline</span></a>
<a class="sourceLine" id="cb47-3" data-line-number="3"><span class="co">-- &gt;&gt;&gt; :set -XFlexibleContexts</span></a>
<a class="sourceLine" id="cb47-4" data-line-number="4"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb47-5" data-line-number="5"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb47-6" data-line-number="6"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb47-7" data-line-number="7"><span class="co">--     &quot;abc\ndef&quot; &#39;g&#39; &quot;\nhi&quot;</span></a>
<a class="sourceLine" id="cb47-8" data-line-number="8"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb47-9" data-line-number="9"><span class="co">--     &quot;&quot; &#39;d&#39; &quot;efg\nhi&quot;</span></a>
<a class="sourceLine" id="cb47-10" data-line-number="10"><span class="co">--   z = FT.fromList $ map Cell</span></a>
<a class="sourceLine" id="cb47-11" data-line-number="11"><span class="co">--     &quot;abc\n&quot;</span></a>
<a class="sourceLine" id="cb47-12" data-line-number="12"><span class="co">-- in (z, Just y) == takeFirstScreenLine x</span></a>
<a class="sourceLine" id="cb47-13" data-line-number="13"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb47-14" data-line-number="14"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb47-15" data-line-number="15"><span class="co">--</span></a>
<a class="sourceLine" id="cb47-16" data-line-number="16"><span class="co">-- &gt;&gt;&gt; -- No full screen lines</span></a>
<a class="sourceLine" id="cb47-17" data-line-number="17"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb47-18" data-line-number="18"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb47-19" data-line-number="19"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb47-20" data-line-number="20"><span class="co">--     &quot;a&quot; &#39;b&#39; &quot;c&quot;</span></a>
<a class="sourceLine" id="cb47-21" data-line-number="21"><span class="co">--   y = FT.fromList</span></a>
<a class="sourceLine" id="cb47-22" data-line-number="22"><span class="co">--     [ Cell &#39;a&#39;, Cell &#39;b&#39;, Cell &#39;c&#39;, EOF ]</span></a>
<a class="sourceLine" id="cb47-23" data-line-number="23"><span class="co">-- in (y, Nothing) == takeFirstScreenLine x</span></a>
<a class="sourceLine" id="cb47-24" data-line-number="24"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb47-25" data-line-number="25"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb47-26" data-line-number="26"><span class="co">--</span></a>
<a class="sourceLine" id="cb47-27" data-line-number="27"><span class="co">-- &gt;&gt;&gt; -- All newlines</span></a>
<a class="sourceLine" id="cb47-28" data-line-number="28"><span class="co">-- &gt;&gt;&gt; :set -XFlexibleContexts</span></a>
<a class="sourceLine" id="cb47-29" data-line-number="29"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb47-30" data-line-number="30"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb47-31" data-line-number="31"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb47-32" data-line-number="32"><span class="co">--     &quot;\n\n\n&quot; &#39;\n&#39; &quot;\n&quot;</span></a>
<a class="sourceLine" id="cb47-33" data-line-number="33"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb47-34" data-line-number="34"><span class="co">--     &quot;&quot; &#39;\n&#39; &quot;\n\n\n&quot;</span></a>
<a class="sourceLine" id="cb47-35" data-line-number="35"><span class="co">--   z = FT.fromList $ map Cell</span></a>
<a class="sourceLine" id="cb47-36" data-line-number="36"><span class="co">--     &quot;\n&quot;</span></a>
<a class="sourceLine" id="cb47-37" data-line-number="37"><span class="co">-- in (z, Just y) == takeFirstScreenLine x</span></a>
<a class="sourceLine" id="cb47-38" data-line-number="38"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb47-39" data-line-number="39"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb47-40" data-line-number="40"><span class="co">--</span></a>
<a class="sourceLine" id="cb47-41" data-line-number="41"><span class="co">-- &gt;&gt;&gt; -- Full screen line with no newlines</span></a>
<a class="sourceLine" id="cb47-42" data-line-number="42"><span class="co">-- &gt;&gt;&gt; :set -XFlexibleContexts</span></a>
<a class="sourceLine" id="cb47-43" data-line-number="43"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb47-44" data-line-number="44"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb47-45" data-line-number="45"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb47-46" data-line-number="46"><span class="co">--     &quot;abcdefghij&quot; &#39;k&#39; &quot;lmn&quot;</span></a>
<a class="sourceLine" id="cb47-47" data-line-number="47"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb47-48" data-line-number="48"><span class="co">--     &quot;&quot; &#39;i&#39; &quot;jklmn&quot;</span></a>
<a class="sourceLine" id="cb47-49" data-line-number="49"><span class="co">--   z = FT.fromList $ map Cell</span></a>
<a class="sourceLine" id="cb47-50" data-line-number="50"><span class="co">--     &quot;abcdefgh&quot;</span></a>
<a class="sourceLine" id="cb47-51" data-line-number="51"><span class="co">-- in (z, Just y) == takeFirstScreenLine x</span></a>
<a class="sourceLine" id="cb47-52" data-line-number="52"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb47-53" data-line-number="53"><span class="co">-- True</span></a></code></pre></div>
</div>
<p>After taking the first screen line, the next step in complexity is to take some number of screen lines from the front of the buffer. This is a pretty straightforward application of an accumulating recursive function.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb48-1" data-line-number="1">takeScreenLines</a>
<a class="sourceLine" id="cb48-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb48-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb48-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb48-5" data-line-number="5">  <span class="ot">-&gt;</span> ( [ <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> a) ]</a>
<a class="sourceLine" id="cb48-6" data-line-number="6">     , <span class="dt">Maybe</span> (<span class="dt">Buffer</span> w t d a) )</a>
<a class="sourceLine" id="cb48-7" data-line-number="7">takeScreenLines n <span class="fu">=</span> accum <span class="dv">0</span> []</a>
<a class="sourceLine" id="cb48-8" data-line-number="8">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb48-9" data-line-number="9">    accum</a>
<a class="sourceLine" id="cb48-10" data-line-number="10"><span class="ot">      ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb48-11" data-line-number="11">      <span class="ot">-&gt;</span> [ <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> a) ]</a>
<a class="sourceLine" id="cb48-12" data-line-number="12">      <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb48-13" data-line-number="13">      <span class="ot">-&gt;</span> ( [ <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> a) ]</a>
<a class="sourceLine" id="cb48-14" data-line-number="14">         , <span class="dt">Maybe</span> (<span class="dt">Buffer</span> w t d a) )</a>
<a class="sourceLine" id="cb48-15" data-line-number="15">    accum k as buf <span class="fu">=</span></a>
<a class="sourceLine" id="cb48-16" data-line-number="16">      <span class="kw">if</span> (k <span class="fu">&gt;=</span> n)</a>
<a class="sourceLine" id="cb48-17" data-line-number="17">        <span class="kw">then</span> (reverse as, <span class="dt">Just</span> buf)</a>
<a class="sourceLine" id="cb48-18" data-line-number="18">        <span class="kw">else</span> <span class="kw">case</span> takeFirstScreenLine buf <span class="kw">of</span></a>
<a class="sourceLine" id="cb48-19" data-line-number="19">          (a, <span class="dt">Nothing</span>) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb48-20" data-line-number="20">            (reverse (a<span class="fu">:</span>as), <span class="dt">Nothing</span>)</a>
<a class="sourceLine" id="cb48-21" data-line-number="21">          (a, <span class="dt">Just</span> buf&#39;) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb48-22" data-line-number="22">            accum (k<span class="fu">+</span><span class="dv">1</span>) (a<span class="fu">:</span>as) buf&#39;</a></code></pre></div>
<p>Interesting examples of this are a little more verbose:</p>
<div class="doctest">
<div class="sourceCode" id="cb49"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb49-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb49-2" data-line-number="2"><span class="co">-- &gt;&gt;&gt; :set -XFlexibleContexts</span></a>
<a class="sourceLine" id="cb49-3" data-line-number="3"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb49-4" data-line-number="4"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb49-5" data-line-number="5"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb49-6" data-line-number="6"><span class="co">--     &quot;abc\ndef&quot; &#39;g&#39; &quot;\nhi&quot;</span></a>
<a class="sourceLine" id="cb49-7" data-line-number="7"><span class="co">--   y = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb49-8" data-line-number="8"><span class="co">--     &quot;&quot; &#39;h&#39; &quot;i&quot;</span></a>
<a class="sourceLine" id="cb49-9" data-line-number="9"><span class="co">--   zs = </span></a>
<a class="sourceLine" id="cb49-10" data-line-number="10"><span class="co">--     [ FT.fromList $ map Cell</span></a>
<a class="sourceLine" id="cb49-11" data-line-number="11"><span class="co">--         &quot;abc\n&quot;</span></a>
<a class="sourceLine" id="cb49-12" data-line-number="12"><span class="co">--     , FT.fromList $ map Cell</span></a>
<a class="sourceLine" id="cb49-13" data-line-number="13"><span class="co">--         &quot;defg\n&quot;</span></a>
<a class="sourceLine" id="cb49-14" data-line-number="14"><span class="co">--     ]</span></a>
<a class="sourceLine" id="cb49-15" data-line-number="15"><span class="co">-- in (zs, Just y) == takeScreenLines 2 x</span></a>
<a class="sourceLine" id="cb49-16" data-line-number="16"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb49-17" data-line-number="17"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb49-18" data-line-number="18"><span class="co">--</span></a>
<a class="sourceLine" id="cb49-19" data-line-number="19"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb49-20" data-line-number="20"><span class="co">-- &gt;&gt;&gt; :set -XFlexibleContexts</span></a>
<a class="sourceLine" id="cb49-21" data-line-number="21"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb49-22" data-line-number="22"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb49-23" data-line-number="23"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb49-24" data-line-number="24"><span class="co">--     &quot;abc\nd&quot; &#39;e&#39; &quot;f&quot;</span></a>
<a class="sourceLine" id="cb49-25" data-line-number="25"><span class="co">--   zs = </span></a>
<a class="sourceLine" id="cb49-26" data-line-number="26"><span class="co">--     [ FT.fromList $ map Cell</span></a>
<a class="sourceLine" id="cb49-27" data-line-number="27"><span class="co">--         &quot;abc\n&quot;</span></a>
<a class="sourceLine" id="cb49-28" data-line-number="28"><span class="co">--     , FT.fromList</span></a>
<a class="sourceLine" id="cb49-29" data-line-number="29"><span class="co">--         [ Cell &#39;d&#39;, Cell &#39;e&#39;, Cell &#39;f&#39;, EOF ]</span></a>
<a class="sourceLine" id="cb49-30" data-line-number="30"><span class="co">--     ]</span></a>
<a class="sourceLine" id="cb49-31" data-line-number="31"><span class="co">-- in (zs, Nothing) == takeScreenLines 3 x</span></a>
<a class="sourceLine" id="cb49-32" data-line-number="32"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb49-33" data-line-number="33"><span class="co">-- True</span></a></code></pre></div>
</div>
<p>Now we’re prepared to extract a ‘screenful’ of screen lines from anywhere in the buffer with <code>getScreenLines</code>. This function returns the accumulated <code>MeasureText</code> up to the extracted lines; we’ll need this to compute the (logical) line numbers.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb50-1" data-line-number="1">getScreenLines</a>
<a class="sourceLine" id="cb50-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb50-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb50-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="co">-- top screen line</span></a>
<a class="sourceLine" id="cb50-5" data-line-number="5">  <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="co">-- view height</span></a>
<a class="sourceLine" id="cb50-6" data-line-number="6">  <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb50-7" data-line-number="7">  <span class="ot">-&gt;</span> ( <span class="dt">MeasureText</span> w t d</a>
<a class="sourceLine" id="cb50-8" data-line-number="8">     , [ <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> a) ] )</a>
<a class="sourceLine" id="cb50-9" data-line-number="9">getScreenLines t h buf <span class="fu">=</span></a>
<a class="sourceLine" id="cb50-10" data-line-number="10">  <span class="kw">case</span> movePointToScreenLine t buf <span class="kw">of</span></a>
<a class="sourceLine" id="cb50-11" data-line-number="11">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> ( value buf, [] )</a>
<a class="sourceLine" id="cb50-12" data-line-number="12">    <span class="dt">Just</span> (<span class="dt">Buffer</span> w _) <span class="ot">-&gt;</span> <span class="kw">case</span> w <span class="kw">of</span></a>
<a class="sourceLine" id="cb50-13" data-line-number="13">      <span class="dt">TPL.Vacant</span> <span class="ot">-&gt;</span> (mempty, [])</a>
<a class="sourceLine" id="cb50-14" data-line-number="14">      <span class="dt">TPL.PointOnly</span> (as, x, bs) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb50-15" data-line-number="15">        <span class="kw">let</span></a>
<a class="sourceLine" id="cb50-16" data-line-number="16">          (us, _) <span class="fu">=</span> takeScreenLines h</a>
<a class="sourceLine" id="cb50-17" data-line-number="17">            (<span class="dt">Buffer</span> (<span class="dt">TPL.PointOnly</span> (mempty, x, bs)) RBT.empty)</a>
<a class="sourceLine" id="cb50-18" data-line-number="18">        <span class="kw">in</span> (value as, us)</a>
<a class="sourceLine" id="cb50-19" data-line-number="19">      <span class="dt">TPL.Coincide</span> (as, x, bs) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb50-20" data-line-number="20">        <span class="kw">let</span></a>
<a class="sourceLine" id="cb50-21" data-line-number="21">          (us, _) <span class="fu">=</span> takeScreenLines h</a>
<a class="sourceLine" id="cb50-22" data-line-number="22">            (<span class="dt">Buffer</span> (<span class="dt">TPL.PointOnly</span> (mempty, x, bs)) RBT.empty)</a>
<a class="sourceLine" id="cb50-23" data-line-number="23">        <span class="kw">in</span> (value as, us)</a>
<a class="sourceLine" id="cb50-24" data-line-number="24">      <span class="dt">TPL.PointMark</span> (as, x, bs, y, cs) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb50-25" data-line-number="25">        <span class="kw">let</span></a>
<a class="sourceLine" id="cb50-26" data-line-number="26">          (us, _) <span class="fu">=</span> takeScreenLines h</a>
<a class="sourceLine" id="cb50-27" data-line-number="27">            (<span class="dt">Buffer</span> (<span class="dt">TPL.PointOnly</span> (mempty, x, bs <span class="fu">&lt;&gt;</span> FT.cons y cs)) RBT.empty)</a>
<a class="sourceLine" id="cb50-28" data-line-number="28">        <span class="kw">in</span> (value as, us)</a>
<a class="sourceLine" id="cb50-29" data-line-number="29">      <span class="dt">TPL.MarkPoint</span> (as, x, bs, y, cs) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb50-30" data-line-number="30">        <span class="kw">let</span></a>
<a class="sourceLine" id="cb50-31" data-line-number="31">          (us, _) <span class="fu">=</span> takeScreenLines h</a>
<a class="sourceLine" id="cb50-32" data-line-number="32">            (<span class="dt">Buffer</span> (<span class="dt">TPL.PointOnly</span> (mempty, y, cs)) RBT.empty)</a>
<a class="sourceLine" id="cb50-33" data-line-number="33">        <span class="kw">in</span> (value (as <span class="fu">&lt;&gt;</span> FT.cons x bs), us)</a></code></pre></div>
<p>Next we can attach the logical line numbers to the screen lines. (<em>Logical</em> here means lines as separated by newline characters; these can be broken across several screen lines.)</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb51-1" data-line-number="1">attachLineNumbers</a>
<a class="sourceLine" id="cb51-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb51-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb51-4" data-line-number="4">  <span class="ot">=&gt;</span> ( <span class="dt">MeasureText</span> w t d</a>
<a class="sourceLine" id="cb51-5" data-line-number="5">     , [ <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> a) ] )</a>
<a class="sourceLine" id="cb51-6" data-line-number="6">  <span class="ot">-&gt;</span> [ ( <span class="dt">Maybe</span> <span class="dt">Int</span>, <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> a) ) ]</a>
<a class="sourceLine" id="cb51-7" data-line-number="7">attachLineNumbers (ctx, xs) <span class="fu">=</span> <span class="kw">case</span> xs <span class="kw">of</span></a>
<a class="sourceLine" id="cb51-8" data-line-number="8">  [] <span class="ot">-&gt;</span> []</a>
<a class="sourceLine" id="cb51-9" data-line-number="9">  u<span class="fu">:</span>us <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb51-10" data-line-number="10">    <span class="kw">let</span></a>
<a class="sourceLine" id="cb51-11" data-line-number="11">      <span class="dt">LineCol</span> k h <span class="fu">=</span> logicalCoords ctx <span class="fu">&lt;&gt;</span> logicalOffset ctx</a>
<a class="sourceLine" id="cb51-12" data-line-number="12">      v <span class="fu">=</span> <span class="kw">if</span> h <span class="fu">==</span> <span class="dv">0</span> <span class="kw">then</span> <span class="dt">Just</span> k <span class="kw">else</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb51-13" data-line-number="13">    <span class="kw">in</span> (v,u) <span class="fu">:</span> attachLineNumbers ( ctx <span class="fu">&lt;&gt;</span> value u, us )</a></code></pre></div>
<p>We will also need to know the expected column index of each rendered character later on – this is so we can render tabs correctly.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb52-1" data-line-number="1">attachColumnIndices</a>
<a class="sourceLine" id="cb52-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb52-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb52-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) (<span class="dt">Cell</span> a)</a>
<a class="sourceLine" id="cb52-5" data-line-number="5">  <span class="ot">-&gt;</span> [(a, <span class="dt">Int</span>)]</a>
<a class="sourceLine" id="cb52-6" data-line-number="6">attachColumnIndices xs <span class="fu">=</span></a>
<a class="sourceLine" id="cb52-7" data-line-number="7">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb52-8" data-line-number="8"><span class="ot">    ys ::</span> <span class="dt">FT.FingerTree</span> (<span class="dt">MeasureText</span> w t d) a</a>
<a class="sourceLine" id="cb52-9" data-line-number="9">    ys <span class="fu">=</span> FT.inflateWith listCell xs</a>
<a class="sourceLine" id="cb52-10" data-line-number="10"></a>
<a class="sourceLine" id="cb52-11" data-line-number="11"><span class="ot">    f ::</span> (a, <span class="dt">MeasureText</span> w t d) <span class="ot">-&gt;</span> (a, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb52-12" data-line-number="12">    f (a, m) <span class="fu">=</span></a>
<a class="sourceLine" id="cb52-13" data-line-number="13">      <span class="kw">let</span> (w, _) <span class="fu">=</span> applyScreenOffset (screenCoords m) (<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb52-14" data-line-number="14">      <span class="kw">in</span> (a, w)</a>
<a class="sourceLine" id="cb52-15" data-line-number="15">  <span class="kw">in</span></a>
<a class="sourceLine" id="cb52-16" data-line-number="16">    map f <span class="fu">$</span> FT.toAnnotatedList ys</a></code></pre></div>
<p>Putting it all together, <code>renderScreenLinesWithRegion</code> extracts (1) a list of screen lines with column indices attached to each character, and (2) a list of logical line numbers.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb53-1" data-line-number="1">renderScreenLinesWithRegion</a>
<a class="sourceLine" id="cb53-2" data-line-number="2"><span class="ot">  ::</span> forall w t d a</a>
<a class="sourceLine" id="cb53-3" data-line-number="3">   <span class="fu">.</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a, <span class="dt">IsChar</span> a )</a>
<a class="sourceLine" id="cb53-4" data-line-number="4">  <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> a) <span class="co">-- apply to the region</span></a>
<a class="sourceLine" id="cb53-5" data-line-number="5">  <span class="ot">-&gt;</span> <span class="dt">Int</span>      <span class="co">-- top screen line</span></a>
<a class="sourceLine" id="cb53-6" data-line-number="6">  <span class="ot">-&gt;</span> <span class="dt">Int</span>      <span class="co">-- view height</span></a>
<a class="sourceLine" id="cb53-7" data-line-number="7">  <span class="ot">-&gt;</span> <span class="dt">Buffer</span> w t d a</a>
<a class="sourceLine" id="cb53-8" data-line-number="8">  <span class="ot">-&gt;</span> ([<span class="dt">Maybe</span> <span class="dt">Int</span>], [[(a, <span class="dt">Int</span>)]])</a>
<a class="sourceLine" id="cb53-9" data-line-number="9">renderScreenLinesWithRegion f t h buf <span class="fu">=</span></a>
<a class="sourceLine" id="cb53-10" data-line-number="10">  unzip</a>
<a class="sourceLine" id="cb53-11" data-line-number="11">    <span class="fu">$</span> map (\(u, v) <span class="ot">-&gt;</span> (u, attachColumnIndices v))</a>
<a class="sourceLine" id="cb53-12" data-line-number="12">    <span class="fu">$</span> attachLineNumbers</a>
<a class="sourceLine" id="cb53-13" data-line-number="13">    <span class="fu">$</span> getScreenLines t h</a>
<a class="sourceLine" id="cb53-14" data-line-number="14">    <span class="fu">$</span> alterRegion f buf</a></code></pre></div>
<p>Testing this “by hand” is awkward, but we can do it.</p>
<div class="doctest">
<div class="sourceCode" id="cb54"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="co">-- $</span></a>
<a class="sourceLine" id="cb54-2" data-line-number="2"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb54-3" data-line-number="3"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb54-4" data-line-number="4"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb54-5" data-line-number="5"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;&quot;</span></a>
<a class="sourceLine" id="cb54-6" data-line-number="6"><span class="co">--   nums = [Just 0]</span></a>
<a class="sourceLine" id="cb54-7" data-line-number="7"><span class="co">--   cells = [[(&#39;a&#39;,0)]]</span></a>
<a class="sourceLine" id="cb54-8" data-line-number="8"><span class="co">-- in (nums, cells) ==</span></a>
<a class="sourceLine" id="cb54-9" data-line-number="9"><span class="co">--     renderScreenLinesWithRegion id 0 1 x</span></a>
<a class="sourceLine" id="cb54-10" data-line-number="10"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb54-11" data-line-number="11"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb54-12" data-line-number="12"><span class="co">--</span></a>
<a class="sourceLine" id="cb54-13" data-line-number="13"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb54-14" data-line-number="14"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb54-15" data-line-number="15"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb54-16" data-line-number="16"><span class="co">--     &quot;&quot; &#39;a&#39; &quot;b&quot;</span></a>
<a class="sourceLine" id="cb54-17" data-line-number="17"><span class="co">--   nums = [Just 0]</span></a>
<a class="sourceLine" id="cb54-18" data-line-number="18"><span class="co">--   cells = [[(&#39;a&#39;,0),(&#39;b&#39;,1)]]</span></a>
<a class="sourceLine" id="cb54-19" data-line-number="19"><span class="co">-- in (nums, cells) ==</span></a>
<a class="sourceLine" id="cb54-20" data-line-number="20"><span class="co">--     renderScreenLinesWithRegion id 0 1 x</span></a>
<a class="sourceLine" id="cb54-21" data-line-number="21"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb54-22" data-line-number="22"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb54-23" data-line-number="23"><span class="co">--</span></a>
<a class="sourceLine" id="cb54-24" data-line-number="24"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb54-25" data-line-number="25"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb54-26" data-line-number="26"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb54-27" data-line-number="27"><span class="co">--     &quot;&quot; &#39;\n&#39; &quot;&quot;</span></a>
<a class="sourceLine" id="cb54-28" data-line-number="28"><span class="co">--   nums = [Just 0]</span></a>
<a class="sourceLine" id="cb54-29" data-line-number="29"><span class="co">--   cells = [[(&#39;\n&#39;,0)]]</span></a>
<a class="sourceLine" id="cb54-30" data-line-number="30"><span class="co">-- in (nums, cells) ==</span></a>
<a class="sourceLine" id="cb54-31" data-line-number="31"><span class="co">--     renderScreenLinesWithRegion id 0 1 x</span></a>
<a class="sourceLine" id="cb54-32" data-line-number="32"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb54-33" data-line-number="33"><span class="co">-- True</span></a>
<a class="sourceLine" id="cb54-34" data-line-number="34"><span class="co">--</span></a>
<a class="sourceLine" id="cb54-35" data-line-number="35"><span class="co">-- &gt;&gt;&gt; :{</span></a>
<a class="sourceLine" id="cb54-36" data-line-number="36"><span class="co">-- let</span></a>
<a class="sourceLine" id="cb54-37" data-line-number="37"><span class="co">--   x = makePointOnlyBuffer nat8 nat2 nat10 (EventId 0 &quot;t&quot;)</span></a>
<a class="sourceLine" id="cb54-38" data-line-number="38"><span class="co">--     &quot;&quot; &#39;\t&#39; &quot;a&quot;</span></a>
<a class="sourceLine" id="cb54-39" data-line-number="39"><span class="co">--   nums = [Just 0]</span></a>
<a class="sourceLine" id="cb54-40" data-line-number="40"><span class="co">--   cells = [[(&#39;\t&#39;,0),(&#39;a&#39;,2)]]</span></a>
<a class="sourceLine" id="cb54-41" data-line-number="41"><span class="co">-- in (nums, cells) ==</span></a>
<a class="sourceLine" id="cb54-42" data-line-number="42"><span class="co">--     renderScreenLinesWithRegion id 0 1 x</span></a>
<a class="sourceLine" id="cb54-43" data-line-number="43"><span class="co">-- :}</span></a>
<a class="sourceLine" id="cb54-44" data-line-number="44"><span class="co">-- True</span></a></code></pre></div>
</div>
</section>
<section id="testing-and-debugging" class="level2">
<h2>Testing and Debugging</h2>
<p>As usual, we wrap up this module with some helper code for writing tests. First we need class instances for working with our property testing library.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb55-1" data-line-number="1"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb55-2" data-line-number="2">  ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsChar</span> a, <span class="dt">IsBase</span> d, <span class="dt">Eq</span> a</a>
<a class="sourceLine" id="cb55-3" data-line-number="3">  , <span class="dt">Arb</span> a, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a</a>
<a class="sourceLine" id="cb55-4" data-line-number="4">  ) <span class="ot">=&gt;</span> <span class="dt">Arb</span> (<span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb55-5" data-line-number="5">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb55-6" data-line-number="6">    arb <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb55-7" data-line-number="7">      cs <span class="ot">&lt;-</span> arb</a>
<a class="sourceLine" id="cb55-8" data-line-number="8">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb55-9" data-line-number="9">        meas <span class="fu">=</span> (<span class="ot">runeId ::</span> <span class="dt">MeasureText</span> w t d <span class="ot">-&gt;</span> <span class="dt">Augmented</span> (<span class="dt">RuneId</span> d)) <span class="fu">.</span> (<span class="ot">value ::</span> <span class="dt">Rune</span> d a <span class="ot">-&gt;</span> <span class="dt">MeasureText</span> w t d)</a>
<a class="sourceLine" id="cb55-10" data-line-number="10">        xs <span class="fu">=</span> TPL.fromList <span class="fu">$</span> map <span class="dt">Cell</span> <span class="fu">$</span> sortOn meas cs</a>
<a class="sourceLine" id="cb55-11" data-line-number="11">      return <span class="fu">$</span> <span class="dt">Buffer</span> (TPL.insertAtEnd (<span class="ot">eof ::</span> <span class="dt">Cell</span> (<span class="dt">Rune</span> d a)) xs) RBT.empty</a>
<a class="sourceLine" id="cb55-12" data-line-number="12"></a>
<a class="sourceLine" id="cb55-13" data-line-number="13"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb55-14" data-line-number="14">  ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsChar</span> a, <span class="dt">IsBase</span> d, <span class="dt">Eq</span> a</a>
<a class="sourceLine" id="cb55-15" data-line-number="15">  , <span class="dt">Prune</span> a, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a</a>
<a class="sourceLine" id="cb55-16" data-line-number="16">  ) <span class="ot">=&gt;</span> <span class="dt">Prune</span> (<span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb55-17" data-line-number="17">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb55-18" data-line-number="18">    prune (<span class="dt">Buffer</span> x _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb55-19" data-line-number="19">      <span class="kw">case</span> TPL.viewAtEnd x <span class="kw">of</span></a>
<a class="sourceLine" id="cb55-20" data-line-number="20">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> error <span class="st">&quot;prune: panic (expected eof)&quot;</span></a>
<a class="sourceLine" id="cb55-21" data-line-number="21">        <span class="dt">Just</span> (c, cs) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb55-22" data-line-number="22">          [<span class="dt">Buffer</span> (TPL.insertAtEnd c z) RBT.empty <span class="fu">|</span> z <span class="ot">&lt;-</span> prune cs]</a>
<a class="sourceLine" id="cb55-23" data-line-number="23"></a>
<a class="sourceLine" id="cb55-24" data-line-number="24"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb55-25" data-line-number="25">  ( <span class="dt">IsBase</span> d, <span class="dt">IsChar</span> a, <span class="dt">Eq</span> a, <span class="dt">Arb</span> a</a>
<a class="sourceLine" id="cb55-26" data-line-number="26">  ) <span class="ot">=&gt;</span> <span class="dt">Arb</span> (<span class="dt">BufferOp</span> d a)</a>
<a class="sourceLine" id="cb55-27" data-line-number="27">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb55-28" data-line-number="28">    arb <span class="fu">=</span> pickFrom3</a>
<a class="sourceLine" id="cb55-29" data-line-number="29">      ( <span class="dt">BufferOpIns</span> <span class="fu">&lt;$&gt;</span> arb</a>
<a class="sourceLine" id="cb55-30" data-line-number="30">      , <span class="dt">BufferOpDel</span> <span class="fu">&lt;$&gt;</span> arb</a>
<a class="sourceLine" id="cb55-31" data-line-number="31">      , pure <span class="dt">BufferNoOp</span></a>
<a class="sourceLine" id="cb55-32" data-line-number="32">      )</a>
<a class="sourceLine" id="cb55-33" data-line-number="33"></a>
<a class="sourceLine" id="cb55-34" data-line-number="34"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb55-35" data-line-number="35">  ( <span class="dt">IsBase</span> d, <span class="dt">IsChar</span> a, <span class="dt">Eq</span> a, <span class="dt">Prune</span> a</a>
<a class="sourceLine" id="cb55-36" data-line-number="36">  ) <span class="ot">=&gt;</span> <span class="dt">Prune</span> (<span class="dt">BufferOp</span> d a)</a>
<a class="sourceLine" id="cb55-37" data-line-number="37">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb55-38" data-line-number="38">    prune x <span class="fu">=</span> <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb55-39" data-line-number="39">      <span class="dt">BufferNoOp</span> <span class="ot">-&gt;</span> []</a>
<a class="sourceLine" id="cb55-40" data-line-number="40">      <span class="dt">BufferOpIns</span> r <span class="ot">-&gt;</span> map <span class="dt">BufferOpIns</span> <span class="fu">$</span> prune r</a>
<a class="sourceLine" id="cb55-41" data-line-number="41">      <span class="dt">BufferOpDel</span> r <span class="ot">-&gt;</span> map <span class="dt">BufferOpDel</span> <span class="fu">$</span> prune r</a></code></pre></div>
<p>Next, recall that buffers need to satisfy some invariants: first of all they are built on finger trees, which have invariants of their own, but moreover the buffer must end with an EOF sigil. We expose a helper to check for this.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb56-1" data-line-number="1">validate</a>
<a class="sourceLine" id="cb56-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsChar</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d</a>
<a class="sourceLine" id="cb56-3" data-line-number="3">     , <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a, <span class="dt">Eq</span> a )</a>
<a class="sourceLine" id="cb56-4" data-line-number="4">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb56-5" data-line-number="5">validate (<span class="dt">Buffer</span> w _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb56-6" data-line-number="6">  <span class="kw">case</span> TPL.viewAtEnd w <span class="kw">of</span></a>
<a class="sourceLine" id="cb56-7" data-line-number="7">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb56-8" data-line-number="8">      <span class="dt">False</span></a>
<a class="sourceLine" id="cb56-9" data-line-number="9">    <span class="dt">Just</span> (u, _) <span class="ot">-&gt;</span> </a>
<a class="sourceLine" id="cb56-10" data-line-number="10">      (u <span class="fu">==</span> eof) <span class="fu">&amp;&amp;</span> (TPL.validate w)</a></code></pre></div>
<p>We also expose a function that converts a buffer into a list with all the gritty value details exposed.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb57-1" data-line-number="1">toAnnotatedList</a>
<a class="sourceLine" id="cb57-2" data-line-number="2"><span class="ot">  ::</span> ( <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">Valued</span> (<span class="dt">MeasureText</span> w t d) a )</a>
<a class="sourceLine" id="cb57-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">Buffer</span> w t d a <span class="ot">-&gt;</span> [(<span class="dt">Cell</span> (<span class="dt">Rune</span> d a), <span class="dt">MeasureText</span> w t d)]</a>
<a class="sourceLine" id="cb57-4" data-line-number="4">toAnnotatedList <span class="fu">=</span> TPL.toAnnotatedList <span class="fu">.</span> bufContents</a></code></pre></div>
<p>Finally we give a <code>Show</code> instance to match our structure-aware constructors. This is filed with the debugging methods because we won’t need it in “production”.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="kw">instance</span></a>
<a class="sourceLine" id="cb58-2" data-line-number="2">  ( <span class="dt">Show</span> a, <span class="dt">IsWidth</span> w, <span class="dt">IsTab</span> t, <span class="dt">IsBase</span> d, <span class="dt">IsChar</span> a, <span class="dt">Ord</span> a</a>
<a class="sourceLine" id="cb58-3" data-line-number="3">  ) <span class="ot">=&gt;</span> <span class="dt">Show</span> (<span class="dt">Buffer</span> w t d a)</a>
<a class="sourceLine" id="cb58-4" data-line-number="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb58-5" data-line-number="5">    show (<span class="dt">Buffer</span> w r) <span class="fu">=</span></a>
<a class="sourceLine" id="cb58-6" data-line-number="6">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb58-7" data-line-number="7">        wid <span class="fu">=</span> showWidth (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> w)</a>
<a class="sourceLine" id="cb58-8" data-line-number="8">        tab <span class="fu">=</span> showTab (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> t)</a>
<a class="sourceLine" id="cb58-9" data-line-number="9">      <span class="kw">in</span> <span class="kw">case</span> w <span class="kw">of</span></a>
<a class="sourceLine" id="cb58-10" data-line-number="10">        <span class="dt">TPL.Vacant</span> <span class="ot">-&gt;</span> concat</a>
<a class="sourceLine" id="cb58-11" data-line-number="11">          [ <span class="st">&quot;makeVacantBuffer&quot;</span></a>
<a class="sourceLine" id="cb58-12" data-line-number="12">          , wid, <span class="st">&quot; &quot;</span>, tab</a>
<a class="sourceLine" id="cb58-13" data-line-number="13">          , <span class="st">&quot;\ndeleted: &quot;</span>, show <span class="fu">$</span> RBT.toList r</a>
<a class="sourceLine" id="cb58-14" data-line-number="14">          ]</a>
<a class="sourceLine" id="cb58-15" data-line-number="15">        <span class="dt">TPL.PointOnly</span> (as, x, bs) <span class="ot">-&gt;</span> concat</a>
<a class="sourceLine" id="cb58-16" data-line-number="16">          [ <span class="st">&quot;makePointOnlyBuffer &quot;</span></a>
<a class="sourceLine" id="cb58-17" data-line-number="17">          , wid, <span class="st">&quot; &quot;</span>, tab, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-18" data-line-number="18">          , show <span class="fu">$</span> Fold.toList as, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-19" data-line-number="19">          , show x, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-20" data-line-number="20">          , show <span class="fu">$</span> Fold.toList bs</a>
<a class="sourceLine" id="cb58-21" data-line-number="21">          , <span class="st">&quot;\ndeleted: &quot;</span>, show <span class="fu">$</span> RBT.toList r</a>
<a class="sourceLine" id="cb58-22" data-line-number="22">          ]</a>
<a class="sourceLine" id="cb58-23" data-line-number="23">        <span class="dt">TPL.Coincide</span> (as, x, bs) <span class="ot">-&gt;</span> concat</a>
<a class="sourceLine" id="cb58-24" data-line-number="24">          [ <span class="st">&quot;makeCoincide &quot;</span></a>
<a class="sourceLine" id="cb58-25" data-line-number="25">          , wid, <span class="st">&quot; &quot;</span>, tab, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-26" data-line-number="26">          , show <span class="fu">$</span> Fold.toList as, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-27" data-line-number="27">          , show x, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-28" data-line-number="28">          , show <span class="fu">$</span> Fold.toList bs</a>
<a class="sourceLine" id="cb58-29" data-line-number="29">          , <span class="st">&quot;\ndeleted: &quot;</span>, show <span class="fu">$</span> RBT.toList r</a>
<a class="sourceLine" id="cb58-30" data-line-number="30">          ]</a>
<a class="sourceLine" id="cb58-31" data-line-number="31">        <span class="dt">TPL.PointMark</span> (as, x, bs, y, cs) <span class="ot">-&gt;</span> concat</a>
<a class="sourceLine" id="cb58-32" data-line-number="32">          [ <span class="st">&quot;makePointMarkBuffer &quot;</span></a>
<a class="sourceLine" id="cb58-33" data-line-number="33">          , wid, <span class="st">&quot; &quot;</span>, tab, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-34" data-line-number="34">          , show <span class="fu">$</span> Fold.toList as, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-35" data-line-number="35">          , show x, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-36" data-line-number="36">          , show <span class="fu">$</span> Fold.toList bs, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-37" data-line-number="37">          , show y, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-38" data-line-number="38">          , show <span class="fu">$</span> Fold.toList cs</a>
<a class="sourceLine" id="cb58-39" data-line-number="39">          , <span class="st">&quot;\ndeleted: &quot;</span>, show <span class="fu">$</span> RBT.toList r</a>
<a class="sourceLine" id="cb58-40" data-line-number="40">          ]</a>
<a class="sourceLine" id="cb58-41" data-line-number="41">        <span class="dt">TPL.MarkPoint</span> (as, x, bs, y, cs) <span class="ot">-&gt;</span> concat</a>
<a class="sourceLine" id="cb58-42" data-line-number="42">          [ <span class="st">&quot;makeMarkPointBuffer &quot;</span></a>
<a class="sourceLine" id="cb58-43" data-line-number="43">          , wid, <span class="st">&quot; &quot;</span>, tab, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-44" data-line-number="44">          , show <span class="fu">$</span> Fold.toList as, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-45" data-line-number="45">          , show x, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-46" data-line-number="46">          , show <span class="fu">$</span> Fold.toList bs, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-47" data-line-number="47">          , show y, <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb58-48" data-line-number="48">          , show <span class="fu">$</span> Fold.toList cs</a>
<a class="sourceLine" id="cb58-49" data-line-number="49">          , <span class="st">&quot;\ndeleted: &quot;</span>, show <span class="fu">$</span> RBT.toList r</a>
<a class="sourceLine" id="cb58-50" data-line-number="50">          ]</a></code></pre></div>
</section>
</article>
</body>
</html>
